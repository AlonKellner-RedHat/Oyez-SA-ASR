#!/usr/bin/env bash
set -e # Exit immediately if a command exits with a non-zero status.

# This script runs as the 'vscode' user by default in a dev container.

# --- PART 1: System Dependency Installation ---
# Edited by Cursor: install both socat and screen in one run so base image changes don't leave one missing.
echo "üöÄ Ensuring system dependencies are installed..."
MISSING=
for cmd in socat screen; do
    if ! command -v "$cmd" &> /dev/null; then
        MISSING="${MISSING} ${cmd}"
    fi
done
if [ -n "$MISSING" ]; then
    echo "   Installing missing:$MISSING with sudo..."
    sudo apt-get update && sudo apt-get install -y socat screen
fi
for cmd in socat screen; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "   '$cmd' still not found after attempting install. Aborting."
        exit 1
    fi
done
echo "   System dependencies are ready."


# --- PART 2: GPG Agent Forwarding Setup ---
echo "üöÄ Configuring GPG agent forwarding..."

# Configuration
FORWARD_PORT=23456
HOST_IP="host.docker.internal"
CONTAINER_GPG_SOCKET="/home/vscode/.gnupg/S.gpg-agent"
PUBKEY_IMPORT_FILE="./host_pubkeys.asc"
LOG_FILE="/tmp/gpg_forwarder_client.log"
SCREEN_SESSION_NAME="container-gpg-forwarder"

# Import the public keys exported from the host
if [ -f "${PUBKEY_IMPORT_FILE}" ]; then
    echo "   Found host public keys. Importing..."
    gpg --import "${PUBKEY_IMPORT_FILE}"
    echo "   Public keys imported successfully."
else
    echo "   Warning: Could not find host public key file at ${PUBKEY_IMPORT_FILE}."
fi

# Ensure the .gnupg directory exists with correct permissions
mkdir -p "$(dirname "$CONTAINER_GPG_SOCKET")"
chmod 700 "$(dirname "$CONTAINER_GPG_SOCKET")"

# Remove stale socket so socat can bind (e.g. from a previous run or other process).
# Edited by Cursor: avoid "address already in use" so forwarder can start.
rm -f "${CONTAINER_GPG_SOCKET}"

# Tell GPG to always use the agent for signing operations.
echo "   Ensuring gpg.conf is set to use the agent..."
echo "use-agent" >> /home/vscode/.gnupg/gpg.conf

# Clean up any previous forwarder session and start a new one
echo "   Starting GPG socket forwarder client in a detached screen session..."
screen -S "${SCREEN_SESSION_NAME}" -X quit 2>/dev/null || true

screen -dmS "${SCREEN_SESSION_NAME}" \
    bash -c "socat UNIX-LISTEN:\"${CONTAINER_GPG_SOCKET}\",fork,mode=700 TCP:\"${HOST_IP}:${FORWARD_PORT}\" &> \"${LOG_FILE}\""

# Verification: give socat a moment, then check (non-fatal so container still starts).
sleep 2
if pgrep -f "socat UNIX-LISTEN:${CONTAINER_GPG_SOCKET}" > /dev/null; then
    echo "‚úÖ GPG forwarding client is running successfully in screen session '${SCREEN_SESSION_NAME}'."
else
    echo "‚ö†Ô∏è GPG forwarding client did not start (container will continue)."
    echo "   To debug, run: cat ${LOG_FILE}"
    [ -f "${LOG_FILE}" ] && echo "   Log excerpt:" && head -20 "${LOG_FILE}" | sed 's/^/   /'
fi


# --- PART 3: User-level Tool Configuration ---
echo "üöÄ Configuring user tools..."
git config commit.gpgsign true
git config tag.gpgsign true

uv python install --default
uv python install 3.13
uv tool install pre-commit --with pre-commit-uv --force-reinstall
uv tool install tox --with tox-uv
pre-commit install --install-hooks -t pre-commit -t commit-msg -t post-commit -t pre-push -t prepare-commit-msg

# --- PART 4: sideloaded extensions (not on OpenVSX) ---
# Edited by Cursor: list in vendor-extensions.conf; download missing VSIXs to vendor/.
# Marketplace returns gzip; use --compressed (curl) or gunzip (wget) so the file is valid ZIP.
# See: https://stackoverflow.com/questions/60090123
VENDOR_DIR="/app/.devcontainer/vendor"
CONF="/app/.devcontainer/vendor-extensions.conf"
if [ -f "$CONF" ]; then
	while IFS= read -r line; do
		[[ "$line" =~ ^#.*$ ]] || [[ -z "$line" ]] && continue
		read -r publisher extension_id version <<< "$line"
		VSIX="${VENDOR_DIR}/${publisher}.${extension_id}-${version}.vsix"
		if [ -f "$VSIX" ]; then
			echo "   ${publisher}.${extension_id} already in vendor."
		else
			echo "   Downloading ${publisher}.${extension_id} to vendor..."
			DOWNLOAD_URL="https://marketplace.visualstudio.com/_apis/public/gallery/publishers/${publisher}/vsextensions/${extension_id}/${version}/vspackage"
			TMP_VSIX="${VSIX}.tmp"
			if command -v curl &>/dev/null; then
				curl -sSL --compressed -o "$TMP_VSIX" "$DOWNLOAD_URL" && mv "$TMP_VSIX" "$VSIX" || rm -f "$TMP_VSIX"
			elif command -v wget &>/dev/null; then
				wget -q -O "$TMP_VSIX" "$DOWNLOAD_URL" && (gunzip -c "$TMP_VSIX" > "$VSIX" 2>/dev/null && rm -f "$TMP_VSIX" || mv "$TMP_VSIX" "$VSIX") || rm -f "$TMP_VSIX"
			else
				echo "   Skipping ${publisher}.${extension_id}: no curl/wget. See .devcontainer/vendor/README.md."
			fi
		fi
	done < "$CONF"
fi

echo "‚úÖ All post-create commands completed successfully."
