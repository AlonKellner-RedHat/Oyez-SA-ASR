# Generated by Claude
"""Tests for streaming segment extraction (Option C optimization)."""

import gc
import tempfile
import tracemalloc
from pathlib import Path

import numpy as np
import pytest

from oyez_sa_asr.audio_segment import (
    _encode_flac,
    extract_segments_batch,
    extract_segments_streaming,
)
from oyez_sa_asr.audio_utils import save_audio


def _create_test_audio(duration_sec: float, sample_rate: int = 16000) -> Path:
    """Create a test FLAC audio file with known content."""
    with tempfile.NamedTemporaryFile(suffix=".flac", delete=False) as tmpfile:
        path = Path(tmpfile.name)

    t = np.linspace(0, duration_sec, int(duration_sec * sample_rate), dtype=np.float32)
    samples = np.sin(2 * np.pi * 440 * t) * 0.5
    samples = samples[np.newaxis, :]

    save_audio(samples, sample_rate, path, format="flac", bits_per_sample=16)
    return path


class TestExtractSegmentsStreaming:
    """Tests for streaming segment extraction (Option C)."""

    def test_streaming_extracts_correct_segments(self) -> None:
        """Verify streaming extraction produces valid audio segments."""
        path = _create_test_audio(10.0)
        try:
            segments = [(1.0, 2.0), (4.0, 6.0), (8.0, 9.0)]
            result = extract_segments_streaming(path, segments)

            assert len(result) == 3
            for segment_bytes in result:
                assert isinstance(segment_bytes, bytes)
                assert len(segment_bytes) > 0
                assert segment_bytes[:4] == b"fLaC"
        finally:
            path.unlink()

    def test_streaming_memory_efficient(self) -> None:
        """Verify streaming uses less memory than full load."""
        path = _create_test_audio(30.0)
        try:
            segments = [(i, i + 2.0) for i in range(0, 28, 3)]

            gc.collect()
            tracemalloc.start()
            streaming_result = extract_segments_streaming(path, segments)
            _, streaming_peak = tracemalloc.get_traced_memory()
            tracemalloc.stop()
            del streaming_result
            gc.collect()

            gc.collect()
            tracemalloc.start()
            full_result = extract_segments_batch(path, segments, use_streaming=False)
            _, full_peak = tracemalloc.get_traced_memory()
            tracemalloc.stop()
            del full_result
            gc.collect()

            assert streaming_peak <= full_peak * 1.5
        finally:
            path.unlink()

    def test_streaming_rejects_invalid_time_range(self) -> None:
        """Verify streaming validates time ranges."""
        path = _create_test_audio(5.0)
        try:
            with pytest.raises(ValueError, match="must be <"):
                extract_segments_streaming(path, [(3.0, 2.0)])
        finally:
            path.unlink()

    def test_streaming_empty_segments(self) -> None:
        """Handle empty segments list."""
        path = _create_test_audio(5.0)
        try:
            result = extract_segments_streaming(path, [])
            assert result == []
        finally:
            path.unlink()


class TestEncodeFLAC:
    """Tests for _encode_flac helper function."""

    def test_encode_produces_valid_flac(self) -> None:
        """Verify _encode_flac produces valid FLAC bytes."""
        samples = np.sin(np.linspace(0, 10 * np.pi, 16000)).astype(np.float32)
        samples = samples[np.newaxis, :]

        result = _encode_flac(samples, 16000)
        assert isinstance(result, bytes)
        assert len(result) > 0
        assert result[:4] == b"fLaC"

    def test_encode_with_different_bit_depths(self) -> None:
        """Verify encoding works with 16 and 24 bit depths."""
        samples = np.zeros((1, 8000), dtype=np.float32)

        result_16 = _encode_flac(samples, 16000, bits_per_sample=16)
        result_24 = _encode_flac(samples, 16000, bits_per_sample=24)

        assert result_16[:4] == b"fLaC"
        assert result_24[:4] == b"fLaC"
        assert len(result_24) >= len(result_16)
