# Generated by Claude
"""Tests for speaker_models module utilities."""

from oyez_sa_asr.speaker_models import (
    MIN_CASES_FOR_JUSTICE,
    MIN_TERMS_FOR_JUSTICE,
    RecordingAppearance,
    SpeakerProfile,
    TermStats,
    slugify_name,
)


class TestSlugifyName:
    """Tests for slugify_name function."""

    def test_simple_name(self) -> None:
        """Convert simple name to slug."""
        assert slugify_name("John Smith") == "john_smith"

    def test_name_with_suffix(self) -> None:
        """Handle Jr., Sr. suffixes."""
        assert slugify_name("John G. Roberts, Jr.") == "john_g_roberts_jr"

    def test_name_with_special_chars(self) -> None:
        """Remove special characters."""
        assert slugify_name("O'Connor") == "oconnor"

    def test_multiple_spaces(self) -> None:
        """Collapse multiple spaces."""
        assert slugify_name("John   Smith") == "john_smith"

    def test_empty_name(self) -> None:
        """Handle empty name."""
        assert slugify_name("") == ""


class TestAutoRoleDetection:
    """Tests for automatic role detection based on appearance patterns."""

    def test_justice_detection_many_cases_many_terms(self) -> None:
        """Detect justice with many cases across multiple terms."""
        profile = SpeakerProfile(id=123, name="Test Justice")

        # Add appearances across multiple terms exceeding thresholds
        # Need 200+ cases and 5+ terms
        for term in ["2018", "2019", "2020", "2021", "2022", "2023"]:
            for i in range(40):  # 40 cases per term = 240 total
                profile.add_appearance(
                    term=term,
                    docket=f"{term[-2:]}-{i}",
                    case_name=f"Case {i}",
                    transcript_type="oral_argument",
                    turns=5,
                    duration_seconds=100.0,
                    word_count=500,
                )

        profile.finalize()
        assert profile.role == "justice"
        assert len(profile.cases) >= MIN_CASES_FOR_JUSTICE
        assert len(profile._term_stats) >= MIN_TERMS_FOR_JUSTICE

    def test_other_detection_few_cases(self) -> None:
        """Detect other (advocate) with few cases."""
        profile = SpeakerProfile(id=456, name="Test Advocate")

        # Add just a few appearances
        for i in range(3):
            profile.add_appearance(
                term="2024",
                docket=f"24-{i}",
                case_name=f"Case {i}",
                transcript_type="oral_argument",
                turns=5,
                duration_seconds=100.0,
                word_count=500,
            )

        profile.finalize()
        assert profile.role == "other"

    def test_other_detection_many_cases_one_term(self) -> None:
        """Detect other when many cases but only one term."""
        profile = SpeakerProfile(id=789, name="Frequent Single Term")

        # Many cases but all in one term
        for i in range(25):
            profile.add_appearance(
                term="2024",
                docket=f"24-{i}",
                case_name=f"Case {i}",
                transcript_type="oral_argument",
                turns=5,
                duration_seconds=100.0,
                word_count=500,
            )

        profile.finalize()
        assert profile.role == "other"  # Only 1 term, not enough


class TestTermStats:
    """Tests for TermStats dataclass."""

    def test_to_dict(self) -> None:
        """Convert to dictionary."""
        stats = TermStats(
            recordings=10,
            turns=100,
            duration_seconds=1234.5,
            word_count=5000,
        )
        result = stats.to_dict()
        assert result["recordings"] == 10
        assert result["turns"] == 100
        assert result["duration_seconds"] == 1234.5
        assert result["word_count"] == 5000


class TestRecordingAppearance:
    """Tests for RecordingAppearance dataclass."""

    def test_to_dict(self) -> None:
        """Convert to dictionary."""
        appearance = RecordingAppearance(
            term="2024",
            docket="23-1234",
            case_name="Smith v. Jones",
            transcript_type="oral_argument",
            turns=45,
            duration_seconds=678.9,
            word_count=4567,
        )
        result = appearance.to_dict()
        assert result["term"] == "2024"
        assert result["docket"] == "23-1234"
        assert result["case_name"] == "Smith v. Jones"
        assert result["transcript_type"] == "oral_argument"
        assert result["turns"] == 45
        assert result["duration_seconds"] == 678.9
        assert result["word_count"] == 4567
