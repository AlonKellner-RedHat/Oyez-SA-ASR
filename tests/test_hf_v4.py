# Generated by Claude
"""Tests specific to HuggingFace datasets v4.x (parquet auto-discovery).

These tests verify that datasets can be loaded via parquet auto-discovery
in HuggingFace datasets v4.x, where loading scripts are no longer supported.
"""

import pytest

from oyez_sa_asr.hf_compat import is_v4

pytestmark = pytest.mark.skipif(not is_v4(), reason="Requires datasets v4.x")


class TestV4VersionDetection:
    """Tests for version detection in v4.x environment."""

    def test_is_v4_returns_true(self) -> None:
        """Verify is_v4() returns True in v4.x environment."""
        assert is_v4() is True


class TestV4ParquetAutoDiscovery:
    """Tests for parquet auto-discovery loading in v4.x."""

    def test_raw_loads_via_parquet(self) -> None:
        """Load raw dataset via parquet auto-discovery."""
        from pathlib import Path

        from datasets import load_dataset  # noqa: PLC0415

        # Skip if dataset files don't exist
        raw_data_dir = Path("datasets/raw/data")
        if not (raw_data_dir / "recordings.parquet").exists():
            pytest.skip("Raw dataset not found - run 'oyez dataset raw' first")

        try:
            ds = load_dataset("datasets/raw", streaming=True)
            sample = next(iter(ds["train"]))
            assert "recording_id" in sample
            assert "audio_path" in sample
            assert "term" in sample
            assert "docket" in sample
        except ImportError as e:
            if "torchcodec" in str(e):
                pytest.skip("torchcodec required for audio decoding in v4.x")
            raise

    def test_flex_recordings_loads_via_parquet(self) -> None:
        """Load flex recordings config via parquet auto-discovery."""
        from pathlib import Path

        # Skip if dataset files don't exist
        flex_data_dir = Path("datasets/flex/data")
        if not (flex_data_dir / "recordings.parquet").exists():
            pytest.skip("Flex dataset not found - run 'oyez dataset flex' first")

        # In v4.x parquet auto-discovery, configs are not available via JsonFlex
        # The custom loading script (OyezFlex) is not used in parquet auto-discovery mode
        # So we skip this test as it requires the custom script with configs
        pytest.skip(
            "Parquet auto-discovery in v4.x doesn't support custom configs - "
            "use loading script instead"
        )

    def test_flex_utterances_loads_via_parquet(self) -> None:
        """Load flex utterances config via parquet (metadata only, no audio)."""
        from pathlib import Path

        # Skip if dataset files don't exist
        flex_data_dir = Path("datasets/flex/data")
        if not (flex_data_dir / "utterances.parquet").exists():
            pytest.skip("Flex dataset not found - run 'oyez dataset flex' first")

        # In v4.x parquet auto-discovery, configs are not available via JsonFlex
        # The custom loading script (OyezFlex) is not used in parquet auto-discovery mode
        # So we skip this test as it requires the custom script with configs
        pytest.skip(
            "Parquet auto-discovery in v4.x doesn't support custom configs - "
            "use loading script instead"
        )

    def test_streaming_mode_returns_iterable(self) -> None:
        """Verify streaming mode returns an iterable dataset."""
        from pathlib import Path

        from datasets import IterableDataset, load_dataset  # noqa: PLC0415

        # Skip if dataset files don't exist
        raw_data_dir = Path("datasets/raw/data")
        if not (raw_data_dir / "recordings.parquet").exists():
            pytest.skip("Raw dataset not found - run 'oyez dataset raw' first")

        try:
            ds = load_dataset("datasets/raw", streaming=True)
            assert isinstance(ds["train"], IterableDataset)
        except ImportError as e:
            if "torchcodec" in str(e):
                pytest.skip("torchcodec required for audio decoding in v4.x")
            raise
