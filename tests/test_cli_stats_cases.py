# Generated by Claude
"""Tests for stats cases CLI command."""

import json
import re
import tempfile
from pathlib import Path

from typer.testing import CliRunner

from oyez_sa_asr.cli import app

runner = CliRunner()


def _strip_ansi(text: str) -> str:
    """Remove ANSI escape codes from text."""
    ansi_pattern = re.compile(r"\x1b\[[0-9;]*m")
    return ansi_pattern.sub("", text)


class TestStatsCases:
    """Tests for stats cases command."""

    def test_help(self) -> None:
        """Shows help."""
        result = runner.invoke(app, ["stats", "cases", "--help"])
        assert result.exit_code == 0
        assert "case" in result.output.lower()

    def test_no_cases(self) -> None:
        """Shows message when no cases found."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            (data_dir / "cases").mkdir()

            result = runner.invoke(app, ["stats", "cases", "--data-dir", str(data_dir)])
            assert result.exit_code == 0
            assert "No cases found" in result.output

    def test_missing_directory(self) -> None:
        """Fails if cases directory doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = runner.invoke(
                app, ["stats", "cases", "--data-dir", str(Path(tmpdir) / "missing")]
            )
            assert result.exit_code == 1
            assert "not found" in result.output

    def test_displays_stats(self) -> None:
        """Displays case statistics."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            cases_dir = data_dir / "cases" / "2024"
            cases_dir.mkdir(parents=True)

            case = {
                "id": 1,
                "name": "Test v. Case",
                "oral_arguments": [{"id": 1}],
                "opinion_announcements": [{"id": 2}],
            }
            (cases_dir / "22-123.json").write_text(json.dumps(case))

            result = runner.invoke(app, ["stats", "cases", "--data-dir", str(data_dir)])
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Case Statistics" in output
            assert "Total cases: 1" in output
            assert "oral arguments: 1" in output
            assert "opinion announcements: 1" in output

    def test_term_filter(self) -> None:
        """Filters by term."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)

            for term in ["2023", "2024"]:
                cases_dir = data_dir / "cases" / term
                cases_dir.mkdir(parents=True)
                case = {"id": 1, "oral_arguments": [], "opinion_announcements": []}
                (cases_dir / "docket.json").write_text(json.dumps(case))

            result = runner.invoke(
                app, ["stats", "cases", "--data-dir", str(data_dir), "--term", "2024"]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Total cases: 1" in output

    def test_skips_non_directory_entries(self) -> None:
        """Should skip non-directory entries in cases_dir (line 51)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            cases_dir = data_dir / "cases"
            cases_dir.mkdir(parents=True)

            # Create a file (not a directory) in cases_dir
            (cases_dir / "not_a_dir.txt").write_text("test")

            # Create a valid term directory
            term_dir = cases_dir / "2024"
            term_dir.mkdir()
            case = {"id": 1, "oral_arguments": [], "opinion_announcements": []}
            (term_dir / "22-123.json").write_text(json.dumps(case))

            result = runner.invoke(app, ["stats", "cases", "--data-dir", str(data_dir)])
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            # Should only count the valid directory, not the file
            assert "Total cases: 1" in output

    def test_handles_invalid_json_files(self) -> None:
        """Should handle JSON decode errors gracefully (lines 72-73)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            cases_dir = data_dir / "cases" / "2024"
            cases_dir.mkdir(parents=True)

            # Create invalid JSON file
            (cases_dir / "invalid.json").write_text("{ invalid json }")

            # Create valid case file
            case = {"id": 1, "oral_arguments": [], "opinion_announcements": []}
            (cases_dir / "valid.json").write_text(json.dumps(case))

            result = runner.invoke(app, ["stats", "cases", "--data-dir", str(data_dir)])
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            # Should only count the valid case, skip the invalid JSON
            assert "Total cases: 1" in output

    def test_handles_missing_keys_in_case_data(self) -> None:
        """Should handle KeyError when case data is missing required keys (lines 72-73)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            cases_dir = data_dir / "cases" / "2024"
            cases_dir.mkdir(parents=True)

            # Create case file with missing keys
            incomplete_case = {"id": 1}  # Missing oral_arguments, opinion_announcements
            (cases_dir / "incomplete.json").write_text(json.dumps(incomplete_case))

            # Create valid case file
            case = {"id": 2, "oral_arguments": [], "opinion_announcements": []}
            (cases_dir / "valid.json").write_text(json.dumps(case))

            result = runner.invoke(app, ["stats", "cases", "--data-dir", str(data_dir)])
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            # Should handle the KeyError gracefully and count the valid case
            assert "Total cases: 1" in output or "Total cases: 2" in output
