# Generated by Claude
"""TDD tests for CLI restructure with scrape/process subcommands."""

import json
import re
import tempfile
from pathlib import Path
from unittest.mock import AsyncMock, patch

from typer.testing import CliRunner

from oyez_sa_asr.cli import app
from oyez_sa_asr.scraper.models import FetchResult

runner = CliRunner()


def strip_ansi(text: str) -> str:
    """Remove ANSI escape codes from text."""
    return re.sub(r"\x1b\[[0-9;]*m", "", text)


class TestCliStructure:
    """Tests for CLI command structure."""

    def test_scrape_subcommand_exists(self) -> None:
        """Should have a scrape subcommand group."""
        result = runner.invoke(app, ["scrape", "--help"])
        assert result.exit_code == 0
        assert "index" in result.output
        assert "cases" in result.output

    def test_process_subcommand_exists(self) -> None:
        """Should have a process subcommand group."""
        result = runner.invoke(app, ["process", "--help"])
        assert result.exit_code == 0
        assert "index" in result.output


class TestScrapeIndex:
    """Tests for scrape index command."""

    def test_scrape_index_help(self) -> None:
        """Should show help for scrape index."""
        result = runner.invoke(app, ["scrape", "index", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--cache-dir" in output
        assert "--max-pages" in output

    def test_scrape_index_with_force_mode(self) -> None:
        """Should display force mode message (line 56)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            # Mock OyezCasesTraverser to avoid real network requests
            with patch(
                "oyez_sa_asr.cli_scrape.OyezCasesTraverser"
            ) as mock_traverser_cls:
                mock_traverser = mock_traverser_cls.return_value
                mock_traverser.fetch_all = AsyncMock(return_value=[])

                result = runner.invoke(
                    app,
                    [
                        "scrape",
                        "index",
                        "--cache-dir",
                        str(cache_dir),
                        "--force",
                    ],
                )
                output = strip_ansi(result.output)
                assert "Force mode" in output

    def test_scrape_cases_with_terms_and_force(self) -> None:
        """Should display terms and force mode messages (lines 116, 121)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            index_file = Path(tmpdir) / "index.json"
            index_file.write_text('{"cases": []}')

            result = runner.invoke(
                app,
                [
                    "scrape",
                    "cases",
                    "--index-file",
                    str(index_file),
                    "--cache-dir",
                    str(cache_dir),
                    "--term",
                    "2024",
                    "--force",
                ],
            )
            output = strip_ansi(result.output)
            assert "Terms: 2024" in output
            assert "Force mode" in output

    def test_scrape_cases_on_progress_callback(self) -> None:
        """Should call on_progress callback during fetching (lines 150-162)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            index_file = Path(tmpdir) / "index.json"
            index_file.write_text(
                json.dumps(
                    {
                        "cases": [
                            {
                                "href": "https://api.oyez.org/cases/2024/22-123",
                                "term": "2024",
                            }
                        ]
                    }
                )
            )

            with patch("oyez_sa_asr.cli_scrape.AdaptiveFetcher") as mock_fetcher_cls:
                mock_fetcher = mock_fetcher_cls.create.return_value
                mock_fetcher.fetch_batch_adaptive = AsyncMock(return_value=[])

                result = runner.invoke(
                    app,
                    [
                        "scrape",
                        "cases",
                        "--index-file",
                        str(index_file),
                        "--cache-dir",
                        str(cache_dir),
                    ],
                )

                assert result.exit_code == 0
                # Should have called fetch_batch_adaptive with on_progress
                mock_fetcher.fetch_batch_adaptive.assert_called_once()
                call_args = mock_fetcher.fetch_batch_adaptive.call_args
                # on_progress is passed as second positional argument
                assert len(call_args[0]) >= 2, (
                    "on_progress should be passed as positional arg"
                )
                assert callable(call_args[0][1]), (
                    "Second positional arg should be callable (on_progress)"
                )
                call_kwargs = call_args[1] if len(call_args) > 1 else {}
                assert call_kwargs.get("force") is False

    def test_scrape_index_default_cache_dir(self) -> None:
        """Should use .cache/index as default cache directory."""
        with (
            patch("oyez_sa_asr.cli_scrape.AdaptiveFetcher"),
            patch("oyez_sa_asr.cli_scrape.OyezCasesTraverser") as mock_traverser,
        ):
            mock_traverser.return_value.fetch_all = AsyncMock(return_value=[])
            result = runner.invoke(app, ["scrape", "index", "--max-pages", "1"])
            # Check that .cache/index was used
            assert ".cache/index" in result.output or result.exit_code == 0


class TestScrapeCases:
    """Tests for scrape cases command."""

    def test_scrape_cases_help(self) -> None:
        """Should show help for scrape cases."""
        result = runner.invoke(app, ["scrape", "cases", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--index-file" in output
        assert "--cache-dir" in output

    def test_scrape_cases_requires_index(self) -> None:
        """Should error if index file doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = runner.invoke(
                app,
                [
                    "scrape",
                    "cases",
                    "--index-file",
                    f"{tmpdir}/nonexistent.json",
                ],
            )
            assert result.exit_code != 0 or "not found" in result.output.lower()

    def test_scrape_cases_on_progress_creates_pbar(self) -> None:
        """Should create progress bar when on_progress is called (lines 150-162)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            index_file = Path(tmpdir) / "index.json"
            index_file.write_text(
                json.dumps(
                    {
                        "cases": [
                            {
                                "href": "https://api.oyez.org/cases/2024/22-123",
                                "term": "2024",
                            }
                        ]
                    }
                )
            )

            with patch("oyez_sa_asr.cli_scrape.AdaptiveFetcher") as mock_fetcher_cls:
                mock_fetcher = mock_fetcher_cls.create.return_value
                # Return a result to trigger on_progress
                success_result = FetchResult(
                    url="https://api.oyez.org/cases/2024/22-123",
                    success=True,
                    status_code=200,
                )
                mock_fetcher.fetch_batch_adaptive = AsyncMock(
                    return_value=[success_result]
                )

                result = runner.invoke(
                    app,
                    [
                        "scrape",
                        "cases",
                        "--index-file",
                        str(index_file),
                        "--cache-dir",
                        str(cache_dir),
                    ],
                )

                assert result.exit_code == 0
                # Should have called fetch_batch_adaptive with on_progress
                mock_fetcher.fetch_batch_adaptive.assert_called_once()
                call_args = mock_fetcher.fetch_batch_adaptive.call_args
                # on_progress is passed as second positional argument
                assert len(call_args[0]) >= 2, (
                    "on_progress should be passed as positional arg"
                )
                assert callable(call_args[0][1]), (
                    "Second positional arg should be callable (on_progress)"
                )
                call_args[1] if len(call_args) > 1 else {}

    def test_scrape_cases_reads_index_and_fetches(self) -> None:
        """Should read index and fetch case details."""
        with tempfile.TemporaryDirectory() as tmpdir:
            # Create a minimal index file
            index_file = Path(tmpdir) / "cases_index.json"
            index_data = {
                "generated_at": "2026-01-13T00:00:00Z",
                "total_cases": 2,
                "cases": [
                    {"id": 1, "href": "https://api.oyez.org/cases/2020/1"},
                    {"id": 2, "href": "https://api.oyez.org/cases/2020/2"},
                ],
            }
            index_file.write_text(json.dumps(index_data))

            cache_dir = Path(tmpdir) / "cache"

            with patch("oyez_sa_asr.cli_scrape.AdaptiveFetcher") as mock_fetcher_cls:
                mock_fetcher = mock_fetcher_cls.create.return_value
                mock_fetcher.fetch_batch_adaptive = AsyncMock(return_value=[])

                result = runner.invoke(
                    app,
                    [
                        "scrape",
                        "cases",
                        "--index-file",
                        str(index_file),
                        "--cache-dir",
                        str(cache_dir),
                    ],
                )

                assert result.exit_code == 0
                # Should have called fetch_batch_adaptive with 2 requests
                mock_fetcher.fetch_batch_adaptive.assert_called_once()
                call_args = mock_fetcher.fetch_batch_adaptive.call_args[0][0]
                assert len(call_args) == 2


class TestProcessIndex:
    """Tests for process index command."""

    def test_process_index_help(self) -> None:
        """Should show help for process index."""
        result = runner.invoke(app, ["process", "index", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--cache-dir" in output
        assert "--output" in output

    def test_process_index_default_paths(self) -> None:
        """Should use stage-based default paths."""
        result = runner.invoke(app, ["process", "index", "--help"])
        # Default cache should be .cache/index
        # Default output should be data/index/cases_index.json
        assert result.exit_code == 0


class TestClearCommands:
    """Tests for clear subcommands."""

    def test_clear_subcommand_exists(self) -> None:
        """Should have a clear subcommand group."""
        result = runner.invoke(app, ["clear", "--help"])
        assert result.exit_code == 0
        assert "index" in result.output
        assert "cases" in result.output

    def test_clear_index_help(self) -> None:
        """Should show help for clear index."""
        result = runner.invoke(app, ["clear", "index", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--cache-dir" in output
        assert "--data-dir" in output
        assert "--force" in output

    def test_clear_cases_help(self) -> None:
        """Should show help for clear cases."""
        result = runner.invoke(app, ["clear", "cases", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--cache-dir" in output
        assert "--data-dir" in output
        assert "--force" in output

    def test_clear_index_removes_directories(self) -> None:
        """Should remove index cache and data directories."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache" / "index"
            data_dir = Path(tmpdir) / "data" / "index"

            # Create directories with files
            cache_dir.mkdir(parents=True)
            (cache_dir / "test.json").write_text("{}")
            data_dir.mkdir(parents=True)
            (data_dir / "cases_index.json").write_text("{}")

            result = runner.invoke(
                app,
                [
                    "clear",
                    "index",
                    "--cache-dir",
                    str(cache_dir),
                    "--data-dir",
                    str(data_dir),
                    "--force",
                ],
            )

            assert result.exit_code == 0
            assert not cache_dir.exists()
            assert not data_dir.exists()

    def test_clear_cases_removes_directories(self) -> None:
        """Should remove cases cache and data directories."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache" / "cases"
            data_dir = Path(tmpdir) / "data" / "cases"

            # Create directories with files
            cache_dir.mkdir(parents=True)
            (cache_dir / "meta").mkdir()
            (cache_dir / "meta" / "abc.json").write_text("{}")
            data_dir.mkdir(parents=True)
            (data_dir / "case1.json").write_text("{}")

            result = runner.invoke(
                app,
                [
                    "clear",
                    "cases",
                    "--cache-dir",
                    str(cache_dir),
                    "--data-dir",
                    str(data_dir),
                    "--force",
                ],
            )

            assert result.exit_code == 0
            assert not cache_dir.exists()
            assert not data_dir.exists()

    def test_clear_handles_nonexistent_directories(self) -> None:
        """Should handle nonexistent directories gracefully."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "nonexistent_cache"
            data_dir = Path(tmpdir) / "nonexistent_data"

            result = runner.invoke(
                app,
                [
                    "clear",
                    "index",
                    "--cache-dir",
                    str(cache_dir),
                    "--data-dir",
                    str(data_dir),
                    "--force",
                ],
            )

            assert result.exit_code == 0
            assert "does not exist" in result.output

    def test_clear_index_confirmation_cancelled(self) -> None:
        """Should cancel when user says no to confirmation prompt."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache" / "index"
            data_dir = Path(tmpdir) / "data" / "index"

            cache_dir.mkdir(parents=True)
            (cache_dir / "test.json").write_text("{}")
            data_dir.mkdir(parents=True)
            (data_dir / "cases_index.json").write_text("{}")

            # Mock typer.confirm to return False (user cancels)
            with patch("oyez_sa_asr.cli_clear.typer.confirm", return_value=False):
                result = runner.invoke(
                    app,
                    [
                        "clear",
                        "index",
                        "--cache-dir",
                        str(cache_dir),
                        "--data-dir",
                        str(data_dir),
                        # No --force flag
                    ],
                )

                assert result.exit_code == 0
                assert (
                    "Cancelled" in result.output or "cancelled" in result.output.lower()
                )
                # Directories should still exist
                assert cache_dir.exists()
                assert data_dir.exists()

    def test_clear_audio_cache_only_with_confirmation(self) -> None:
        """Should clear audio cache with confirmation prompt."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache" / "audio"
            cache_dir.mkdir(parents=True)
            (cache_dir / "test.mp3").write_text("test")

            # Mock typer.confirm to return True (user confirms)
            with patch("oyez_sa_asr.cli_clear.typer.confirm", return_value=True):
                result = runner.invoke(
                    app,
                    [
                        "clear",
                        "audio",
                        "--cache-dir",
                        str(cache_dir),
                        # No --force flag
                    ],
                )

                assert result.exit_code == 0
                assert not cache_dir.exists()

    def test_clear_audio_cache_only_confirmation_cancelled(self) -> None:
        """Should cancel audio cache clear when user says no."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache" / "audio"
            cache_dir.mkdir(parents=True)
            (cache_dir / "test.mp3").write_text("test")

            # Mock typer.confirm to return False (user cancels)
            with patch("oyez_sa_asr.cli_clear.typer.confirm", return_value=False):
                result = runner.invoke(
                    app,
                    [
                        "clear",
                        "audio",
                        "--cache-dir",
                        str(cache_dir),
                        # No --force flag
                    ],
                )

                assert result.exit_code == 0
                assert (
                    "Cancelled" in result.output or "cancelled" in result.output.lower()
                )
                # Directory should still exist
                assert cache_dir.exists()

    def test_clear_speakers_data_only_with_confirmation(self) -> None:
        """Should clear speakers data with confirmation prompt."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir) / "data" / "speakers"
            data_dir.mkdir(parents=True)
            (data_dir / "justices").mkdir()
            (data_dir / "justices" / "test.json").write_text("{}")

            # Mock typer.confirm to return True (user confirms)
            with patch("oyez_sa_asr.cli_clear.typer.confirm", return_value=True):
                result = runner.invoke(
                    app,
                    [
                        "clear",
                        "speakers",
                        "--data-dir",
                        str(data_dir),
                        # No --force flag
                    ],
                )

                assert result.exit_code == 0
                assert not data_dir.exists()

    def test_clear_speakers_data_only_confirmation_cancelled(self) -> None:
        """Should cancel speakers clear when user says no."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir) / "data" / "speakers"
            data_dir.mkdir(parents=True)
            (data_dir / "justices").mkdir()
            (data_dir / "justices" / "test.json").write_text("{}")

            # Mock typer.confirm to return False (user cancels)
            with patch("oyez_sa_asr.cli_clear.typer.confirm", return_value=False):
                result = runner.invoke(
                    app,
                    [
                        "clear",
                        "speakers",
                        "--data-dir",
                        str(data_dir),
                        # No --force flag
                    ],
                )

                assert result.exit_code == 0
                assert (
                    "Cancelled" in result.output or "cancelled" in result.output.lower()
                )
                # Directory should still exist
                assert data_dir.exists()


class TestMainCommand:
    """Tests for main command."""

    def test_main_command(self) -> None:
        """Should execute main command."""
        result = runner.invoke(app, ["main"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        # Should print the message from main()
        assert "Replace this message" in output or "Typer" in output
