# Generated by Claude
"""TDD tests for CLI restructure with scrape/process subcommands."""

import json
import re
import tempfile
from pathlib import Path
from unittest.mock import AsyncMock, patch

from typer.testing import CliRunner

from oyez_sa_asr.cli import app

runner = CliRunner()


def strip_ansi(text: str) -> str:
    """Remove ANSI escape codes from text."""
    return re.sub(r"\x1b\[[0-9;]*m", "", text)


class TestCliStructure:
    """Tests for CLI command structure."""

    def test_scrape_subcommand_exists(self) -> None:
        """Should have a scrape subcommand group."""
        result = runner.invoke(app, ["scrape", "--help"])
        assert result.exit_code == 0
        assert "index" in result.output
        assert "cases" in result.output

    def test_process_subcommand_exists(self) -> None:
        """Should have a process subcommand group."""
        result = runner.invoke(app, ["process", "--help"])
        assert result.exit_code == 0
        assert "index" in result.output


class TestScrapeIndex:
    """Tests for scrape index command."""

    def test_scrape_index_help(self) -> None:
        """Should show help for scrape index."""
        result = runner.invoke(app, ["scrape", "index", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--cache-dir" in output
        assert "--max-pages" in output

    def test_scrape_index_default_cache_dir(self) -> None:
        """Should use .cache/index as default cache directory."""
        with (
            patch("oyez_sa_asr.cli.AdaptiveFetcher"),
            patch("oyez_sa_asr.cli.OyezCasesTraverser") as mock_traverser,
        ):
            mock_traverser.return_value.fetch_all = AsyncMock(return_value=[])
            result = runner.invoke(app, ["scrape", "index", "--max-pages", "1"])
            # Check that .cache/index was used
            assert ".cache/index" in result.output or result.exit_code == 0


class TestScrapeCases:
    """Tests for scrape cases command."""

    def test_scrape_cases_help(self) -> None:
        """Should show help for scrape cases."""
        result = runner.invoke(app, ["scrape", "cases", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--index-file" in output
        assert "--cache-dir" in output

    def test_scrape_cases_requires_index(self) -> None:
        """Should error if index file doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = runner.invoke(
                app,
                [
                    "scrape",
                    "cases",
                    "--index-file",
                    f"{tmpdir}/nonexistent.json",
                ],
            )
            assert result.exit_code != 0 or "not found" in result.output.lower()

    def test_scrape_cases_reads_index_and_fetches(self) -> None:
        """Should read index and fetch case details."""
        with tempfile.TemporaryDirectory() as tmpdir:
            # Create a minimal index file
            index_file = Path(tmpdir) / "cases_index.json"
            index_data = {
                "generated_at": "2026-01-13T00:00:00Z",
                "total_cases": 2,
                "cases": [
                    {"id": 1, "href": "https://api.oyez.org/cases/2020/1"},
                    {"id": 2, "href": "https://api.oyez.org/cases/2020/2"},
                ],
            }
            index_file.write_text(json.dumps(index_data))

            cache_dir = Path(tmpdir) / "cache"

            with patch("oyez_sa_asr.cli.AdaptiveFetcher") as mock_fetcher_cls:
                mock_fetcher = mock_fetcher_cls.create.return_value
                mock_fetcher.fetch_batch = AsyncMock(return_value=[])

                result = runner.invoke(
                    app,
                    [
                        "scrape",
                        "cases",
                        "--index-file",
                        str(index_file),
                        "--cache-dir",
                        str(cache_dir),
                    ],
                )

                assert result.exit_code == 0
                # Should have called fetch_batch with 2 requests
                mock_fetcher.fetch_batch.assert_called_once()
                call_args = mock_fetcher.fetch_batch.call_args[0][0]
                assert len(call_args) == 2


class TestProcessIndex:
    """Tests for process index command."""

    def test_process_index_help(self) -> None:
        """Should show help for process index."""
        result = runner.invoke(app, ["process", "index", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--cache-dir" in output
        assert "--output" in output

    def test_process_index_default_paths(self) -> None:
        """Should use stage-based default paths."""
        result = runner.invoke(app, ["process", "index", "--help"])
        # Default cache should be .cache/index
        # Default output should be data/index/cases_index.json
        assert result.exit_code == 0
