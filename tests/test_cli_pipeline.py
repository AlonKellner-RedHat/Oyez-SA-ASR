# Generated by Claude
"""Tests for pipeline CLI command."""

import re
from unittest.mock import MagicMock, patch

import pytest
from typer.testing import CliRunner

from oyez_sa_asr.cli import app
from oyez_sa_asr.cli_pipeline import _build_term_args, _run_step, _validate_term

runner = CliRunner()


def _strip_ansi(text: str) -> str:
    """Strip ANSI escape codes from a string."""
    return re.sub(r"\x1b\[[0-9;]*m", "", text)


class TestPipelineHelp:
    """Tests for help output."""

    def test_pipeline_help(self) -> None:
        """Show pipeline help."""
        result = runner.invoke(app, ["pipeline", "--help"])
        assert result.exit_code == 0
        assert "pipeline" in result.output.lower()

    def test_pipeline_run_help(self) -> None:
        """Show pipeline run help."""
        result = runner.invoke(app, ["pipeline", "run", "--help"])
        output = _strip_ansi(result.output)
        assert result.exit_code == 0
        assert "--term" in output or "-T" in output
        assert "--skip-scrape" in output
        assert "--skip-process" in output
        assert "--skip-dataset" in output


class TestPipelineOptions:
    """Tests for pipeline option parsing."""

    def test_term_option_parsing(self) -> None:
        """Parse term option correctly."""
        # Just verify the command accepts the options without erroring on parsing
        result = runner.invoke(
            app,
            [
                "pipeline",
                "run",
                "--term",
                "2024",
                "--skip-scrape",
                "--skip-process",
                "--skip-dataset",
            ],
        )
        # With all phases skipped, it should complete successfully
        output = _strip_ansi(result.output)
        assert "Pipeline Summary" in output
        assert "Pipeline completed successfully" in output

    def test_multiple_terms(self) -> None:
        """Accept multiple term options."""
        result = runner.invoke(
            app,
            [
                "pipeline",
                "run",
                "--term",
                "2023",
                "--term",
                "2024",
                "--skip-scrape",
                "--skip-process",
                "--skip-dataset",
            ],
        )
        output = _strip_ansi(result.output)
        assert result.exit_code == 0
        assert "2023" in output or "2024" in output


class TestPipelineExecution:
    """Tests for pipeline execution flow."""

    def test_all_phases_skipped_succeeds(self) -> None:
        """Skip all phases results in success."""
        result = runner.invoke(
            app,
            [
                "pipeline",
                "run",
                "--skip-scrape",
                "--skip-process",
                "--skip-dataset",
            ],
        )
        output = _strip_ansi(result.output)
        assert result.exit_code == 0
        assert "Pipeline completed successfully" in output

    def test_displays_term_info(self) -> None:
        """Display term information in output."""
        result = runner.invoke(
            app,
            [
                "pipeline",
                "run",
                "--term",
                "2024",
                "--skip-scrape",
                "--skip-process",
                "--skip-dataset",
            ],
        )
        output = _strip_ansi(result.output)
        assert "2024" in output

    def test_displays_all_terms_when_none_specified(self) -> None:
        """Display 'all available' when no terms specified."""
        result = runner.invoke(
            app,
            [
                "pipeline",
                "run",
                "--skip-scrape",
                "--skip-process",
                "--skip-dataset",
            ],
        )
        output = _strip_ansi(result.output)
        assert "all available" in output.lower()


class TestValidateTerm:
    """Tests for _validate_term helper."""

    def test_valid_year(self) -> None:
        """Accept valid 4-digit year."""
        assert _validate_term("2024") == "2024"
        assert _validate_term("1955") == "1955"

    def test_invalid_non_numeric(self) -> None:
        """Reject non-numeric input."""
        with pytest.raises(ValueError, match="must be a 4-digit year"):
            _validate_term("abcd")

    def test_invalid_too_short(self) -> None:
        """Reject too-short input."""
        with pytest.raises(ValueError, match="must be a 4-digit year"):
            _validate_term("24")

    def test_invalid_too_long(self) -> None:
        """Reject too-long input."""
        with pytest.raises(ValueError, match="must be a 4-digit year"):
            _validate_term("20240")


class TestBuildTermArgs:
    """Tests for _build_term_args helper."""

    def test_no_terms(self) -> None:
        """Return empty list for no terms."""
        assert _build_term_args(None) == []
        assert _build_term_args([]) == []

    def test_single_term(self) -> None:
        """Build args for single term."""
        assert _build_term_args(["2024"]) == ["--term", "2024"]

    def test_multiple_terms(self) -> None:
        """Build args for multiple terms."""
        result = _build_term_args(["2023", "2024"])
        assert result == ["--term", "2023", "--term", "2024"]

    def test_rejects_invalid_terms(self) -> None:
        """Reject invalid terms in build_term_args."""
        with pytest.raises(ValueError):
            _build_term_args(["invalid"])


class TestRunStep:
    """Tests for _run_step helper."""

    def test_successful_step(self) -> None:
        """Return True for successful command."""
        mock_result = MagicMock()
        mock_result.returncode = 0
        with patch("oyez_sa_asr.cli_pipeline.subprocess.run", return_value=mock_result):
            result = _run_step("Test Step", ["echo", "hello"])
        assert result is True

    def test_failed_step(self) -> None:
        """Return False for failed command."""
        mock_result = MagicMock()
        mock_result.returncode = 1
        with patch("oyez_sa_asr.cli_pipeline.subprocess.run", return_value=mock_result):
            result = _run_step("Test Step", ["false"])
        assert result is False


class TestPipelineWithMockedSubprocess:
    """Tests for pipeline with mocked subprocess calls."""

    def test_scrape_phase_executes_steps(self) -> None:
        """Execute scrape phase steps when not skipped."""
        mock_result = MagicMock()
        mock_result.returncode = 0
        with patch("oyez_sa_asr.cli_pipeline.subprocess.run", return_value=mock_result):
            result = runner.invoke(
                app,
                ["pipeline", "run", "--skip-process", "--skip-dataset"],
            )
        output = _strip_ansi(result.output)
        assert "Phase 1: Scraping" in output
        assert "Pipeline completed successfully" in output

    def test_process_phase_executes_steps(self) -> None:
        """Execute process phase steps when not skipped."""
        mock_result = MagicMock()
        mock_result.returncode = 0
        with patch("oyez_sa_asr.cli_pipeline.subprocess.run", return_value=mock_result):
            result = runner.invoke(
                app,
                ["pipeline", "run", "--skip-scrape", "--skip-dataset"],
            )
        output = _strip_ansi(result.output)
        assert "Phase 2: Processing" in output
        assert "Pipeline completed successfully" in output

    def test_dataset_phase_executes_steps(self) -> None:
        """Execute dataset phase steps when not skipped."""
        mock_result = MagicMock()
        mock_result.returncode = 0
        with patch("oyez_sa_asr.cli_pipeline.subprocess.run", return_value=mock_result):
            result = runner.invoke(
                app,
                ["pipeline", "run", "--skip-scrape", "--skip-process"],
            )
        output = _strip_ansi(result.output)
        assert "Phase 3: Dataset Creation" in output
        assert "Pipeline completed successfully" in output

    def test_failed_step_reports_error(self) -> None:
        """Report failed steps in summary."""
        mock_result = MagicMock()
        mock_result.returncode = 1
        with patch("oyez_sa_asr.cli_pipeline.subprocess.run", return_value=mock_result):
            result = runner.invoke(
                app,
                ["pipeline", "run", "--skip-process", "--skip-dataset"],
            )
        output = _strip_ansi(result.output)
        assert "Failed steps" in output
        assert result.exit_code == 1
