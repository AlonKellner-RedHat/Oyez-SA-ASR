# Generated by Claude
"""Tests for dataset CLI commands."""

import json
import tempfile
from pathlib import Path

from typer.testing import CliRunner

from oyez_sa_asr.cli import app
from oyez_sa_asr.cli_dataset import (
    _collect_recordings,
    _collect_utterances,
    _copy_tree,
)

runner = CliRunner()


class TestDatasetRaw:
    """Tests for dataset raw command."""

    def test_help(self) -> None:
        """Shows help."""
        result = runner.invoke(app, ["dataset", "raw", "--help"])
        assert result.exit_code == 0
        assert "oyez-sa-asr-raw" in result.output

    def test_creates_output_dir(self) -> None:
        """Creates output directory if it doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            output_dir = Path(tmpdir) / "output"

            # Create empty cache structure
            (cache_dir / "audio").mkdir(parents=True)

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "raw",
                    "--cache-dir",
                    str(cache_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            assert output_dir.exists()
            assert (output_dir / "index.json").exists()


class TestDatasetFlex:
    """Tests for dataset flex command."""

    def test_help(self) -> None:
        """Shows help."""
        result = runner.invoke(app, ["dataset", "flex", "--help"])
        assert result.exit_code == 0
        assert "oyez-sa-asr-flex" in result.output

    def test_creates_parquets(self) -> None:
        """Creates recordings and utterances parquet files."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir) / "data"
            output_dir = Path(tmpdir) / "output"

            # Create audio dir with metadata
            audio_dir = data_dir / "audio" / "2024" / "22-123"
            audio_dir.mkdir(parents=True)
            meta = {
                "duration": 100.0,
                "sample_rate": 16000,
                "channels": 1,
                "source_format": "mp3",
                "source_era": "digital",
            }
            (audio_dir / "20240101a_22-123.metadata.json").write_text(json.dumps(meta))
            (audio_dir / "20240101a_22-123.flac").write_bytes(b"fake flac")

            # Create transcripts dir with turns
            trans_dir = data_dir / "transcripts" / "2024" / "22-123"
            trans_dir.mkdir(parents=True)
            transcript = {
                "term": "2024",
                "case_docket": "22-123",
                "type": "argument",
                "turns": [
                    {
                        "index": 0,
                        "is_valid": True,
                        "start": 0.0,
                        "stop": 10.0,
                        "duration": 10.0,
                        "speaker_id": 1,
                        "speaker_name": "John Roberts",
                        "text": "We will hear argument.",
                        "word_count": 4,
                    }
                ],
            }
            (trans_dir / "argument.json").write_text(json.dumps(transcript))

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "flex",
                    "--data-dir",
                    str(data_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            assert (output_dir / "data" / "recordings.parquet").exists()
            assert (output_dir / "data" / "utterances.parquet").exists()
            assert (output_dir / "index.json").exists()


class TestTermFilter:
    """Tests for --term filter on dataset commands."""

    def test_raw_with_term_filter(self) -> None:
        """Filters to specific term."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            output_dir = Path(tmpdir) / "output"

            # Create cache with multiple terms
            for term in ["2023", "2024"]:
                audio_term = (
                    cache_dir / "audio" / "oyez.case-media.mp3" / "case_data" / term
                )
                audio_term.mkdir(parents=True)
                (audio_term / "docket").mkdir()
                (audio_term / "docket" / "test.mp3").write_bytes(b"mp3")

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "raw",
                    "--cache-dir",
                    str(cache_dir),
                    "--output-dir",
                    str(output_dir),
                    "--term",
                    "2024",
                ],
            )

            assert result.exit_code == 0
            assert (output_dir / "audio" / "2024").exists()
            assert not (output_dir / "audio" / "2023").exists()

    def test_flex_with_term_filter(self) -> None:
        """Filters flex dataset to specific term."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir) / "data"
            output_dir = Path(tmpdir) / "output"

            # Create audio dirs for multiple terms
            for term in ["2023", "2024"]:
                audio_dir = data_dir / "audio" / term / "docket"
                audio_dir.mkdir(parents=True)
                meta = {"duration": 100.0, "sample_rate": 16000, "channels": 1}
                (audio_dir / "rec.metadata.json").write_text(json.dumps(meta))
                (audio_dir / "rec.flac").write_bytes(b"flac")

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "flex",
                    "--data-dir",
                    str(data_dir),
                    "--output-dir",
                    str(output_dir),
                    "--term",
                    "2024",
                ],
            )

            assert result.exit_code == 0
            assert (output_dir / "audio" / "2024").exists()
            assert not (output_dir / "audio" / "2023").exists()


class TestCollectFunctions:
    """Tests for helper collection functions."""

    def test_collect_recordings_empty(self) -> None:
        """Returns empty list for nonexistent directory."""
        result = _collect_recordings(Path("/nonexistent"), None)
        assert result == []

    def test_collect_utterances_empty(self) -> None:
        """Returns empty list for nonexistent directory."""
        result = _collect_utterances(Path("/nonexistent"), None)
        assert result == []

    def test_copy_tree_empty(self) -> None:
        """Returns 0 for nonexistent source."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = _copy_tree(Path("/nonexistent"), Path(tmpdir) / "dst")
            assert result == 0

    def test_collect_recordings_with_data(self) -> None:
        """Collects recordings from processed audio."""
        with tempfile.TemporaryDirectory() as tmpdir:
            audio_dir = Path(tmpdir)
            term_dir = audio_dir / "2024" / "22-123"
            term_dir.mkdir(parents=True)
            meta = {
                "duration": 100.0,
                "sample_rate": 16000,
                "channels": 1,
                "source_format": "mp3",
                "source_era": "digital",
            }
            (term_dir / "rec.metadata.json").write_text(json.dumps(meta))

            result = _collect_recordings(audio_dir, None)
            assert len(result) == 1
            assert result[0]["term"] == "2024"

    def test_collect_utterances_with_data(self) -> None:
        """Collects utterances from processed transcripts."""
        with tempfile.TemporaryDirectory() as tmpdir:
            trans_dir = Path(tmpdir)
            docket_dir = trans_dir / "2024" / "22-123"
            docket_dir.mkdir(parents=True)
            transcript = {
                "term": "2024",
                "case_docket": "22-123",
                "type": "argument",
                "turns": [
                    {
                        "is_valid": True,
                        "index": 0,
                        "start": 0.0,
                        "stop": 5.0,
                        "duration": 5.0,
                        "speaker_name": "Roberts",
                        "text": "Test",
                        "word_count": 1,
                    }
                ],
            }
            (docket_dir / "argument.json").write_text(json.dumps(transcript))

            result = _collect_utterances(trans_dir, None)
            assert len(result) == 1
            assert result[0]["speaker_name"] == "Roberts"
