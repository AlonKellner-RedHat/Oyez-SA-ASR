# Generated by Claude
"""Tests for speakers distribution and role-based stats."""

import json
import re
import tempfile
from pathlib import Path

from typer.testing import CliRunner

from oyez_sa_asr.cli import app

runner = CliRunner()


def _strip_ansi(text: str) -> str:
    """Strip ANSI escape codes from a string."""
    return re.sub(r"\x1b\[[0-9;]*m", "", text)


def _create_speaker_file(
    output_dir: Path,
    speaker_id: int,
    name: str,
    role: str = "other",
    recordings: int = 10,
    turns: int = 100,
    duration: float = 1000.0,
    words: int = 5000,
) -> Path:
    """Create a mock speaker file in role-based subdirectory."""
    name_slug = name.lower().replace(" ", "_").replace(".", "").replace(",", "")
    data = {
        "id": speaker_id,
        "name": name,
        "name_slug": name_slug,
        "role": role,
        "first_appearance": "2020-10-05",
        "last_appearance": "2024-01-15",
        "totals": {
            "recordings": recordings,
            "cases": recordings,
            "turns": turns,
            "duration_seconds": duration,
            "word_count": words,
            "avg_words_per_turn": words / turns if turns > 0 else 0,
        },
        "by_term": {
            "2024": {
                "recordings": recordings,
                "turns": turns,
                "duration_seconds": duration,
                "word_count": words,
            }
        },
        "recordings": [],
        "cases": [],
    }
    subdir = "justices" if role == "justice" else "other"
    target_dir = output_dir / subdir
    target_dir.mkdir(parents=True, exist_ok=True)
    file_path = target_dir / f"{speaker_id}_{name_slug}.json"
    file_path.write_text(json.dumps(data))
    return file_path


class TestRecordingDistribution:
    """Tests for speaker distribution by recording count."""

    def test_displays_recording_distribution(self) -> None:
        """Display speaker distribution by recording count."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            _create_speaker_file(speakers_dir, 1, "One Recording", recordings=1)
            _create_speaker_file(speakers_dir, 2, "Two Recordings", recordings=2)
            _create_speaker_file(speakers_dir, 3, "Five Recordings", recordings=5)
            _create_speaker_file(speakers_dir, 4, "Ten Recordings", recordings=10)
            _create_speaker_file(speakers_dir, 5, "Many Recordings", recordings=15)

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Speakers by recording count" in output
            assert "1 recording:" in output
            assert "2 recordings:" in output
            assert "3-5 recordings:" in output
            assert "6-10 recordings:" in output
            assert "11+ recordings:" in output


class TestTopByRole:
    """Tests for top speakers separated by role."""

    def test_displays_top_by_role(self) -> None:
        """Display top speakers separated by role (justices/others)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            _create_speaker_file(
                speakers_dir, 1, "Justice Alpha", role="justice", recordings=100
            )
            _create_speaker_file(
                speakers_dir, 2, "Justice Beta", role="justice", recordings=50
            )
            _create_speaker_file(
                speakers_dir, 3, "Advocate Gamma", role="advocate", recordings=30
            )
            _create_speaker_file(
                speakers_dir, 4, "Other Delta", role="other", recordings=20
            )

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Top 10 justices by recordings" in output
            assert "Top 10 others by recordings" in output
            assert "Justice Alpha - 100 recordings" in output
            assert "Advocate Gamma - 30 recordings" in output


class TestHoursDistribution:
    """Tests for hours spoken distribution."""

    def test_displays_hours_distribution(self) -> None:
        """Display speaker distribution by time spoken."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            # <1m (30 sec)
            _create_speaker_file(speakers_dir, 1, "Very Brief", duration=30.0)
            # 5-15m (600 sec = 10m)
            _create_speaker_file(speakers_dir, 2, "Brief Speaker", duration=600.0)
            # 30-60m (2400 sec = 40m)
            _create_speaker_file(speakers_dir, 3, "Medium Speaker", duration=2400.0)
            # 1-2h (5400 sec = 1.5h)
            _create_speaker_file(speakers_dir, 4, "Long Speaker", duration=5400.0)
            # 100h+ (400000 sec = 111h)
            _create_speaker_file(speakers_dir, 5, "Very Long", duration=400000.0)

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Speakers by time spoken" in output
            assert "<1m:" in output
            assert "5-15m:" in output
            assert "30-60m:" in output
            assert "1-2h:" in output
            assert "100h+:" in output

    def test_displays_role_hours_breakdown(self) -> None:
        """Display spoken hours breakdown by role."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            # 10h for justice
            _create_speaker_file(
                speakers_dir, 1, "Justice A", role="justice", duration=36000.0
            )
            # 5h for other
            _create_speaker_file(
                speakers_dir, 2, "Other B", role="other", duration=18000.0
            )

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Spoken hours by role" in output
            assert "Justices:" in output
            assert "Others:" in output

    def test_displays_top_by_hours(self) -> None:
        """Display top speakers by hours spoken, separated by role."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            _create_speaker_file(
                speakers_dir, 1, "Justice Alpha", role="justice", duration=100000.0
            )
            _create_speaker_file(
                speakers_dir, 2, "Justice Beta", role="justice", duration=50000.0
            )
            _create_speaker_file(
                speakers_dir, 3, "Advocate Gamma", role="advocate", duration=30000.0
            )

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Top 10 justices by hours spoken" in output
            assert "Top 10 others by hours spoken" in output
            assert "Justice Alpha" in output
            assert "Advocate Gamma" in output
