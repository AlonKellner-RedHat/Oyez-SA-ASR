# Generated by Claude
"""Tests for parse_transcript_type and ProcessedTurn."""

from oyez_sa_asr.scraper.parser_transcripts import (
    ProcessedTurn,
    parse_transcript_type,
)


class TestParseTranscriptType:
    """Tests for parse_transcript_type function."""

    def test_oral_argument(self) -> None:
        """Oral Argument title returns oral_argument type."""
        result = parse_transcript_type("Oral Argument - December 05, 2022")
        assert result == ("oral_argument", None)

    def test_opinion_announcement(self) -> None:
        """Opinion Announcement returns opinion type."""
        result = parse_transcript_type("Opinion Announcement - June 30, 2023")
        assert result == ("opinion", None)

    def test_dissent_new_format(self) -> None:
        """Dissenting Opinion with justice name."""
        result = parse_transcript_type("Dissenting Opinion - Sotomayor - June 30, 2023")
        assert result == ("dissent", "Sotomayor")

    def test_concurrence(self) -> None:
        """Concurring Opinion with justice name."""
        result = parse_transcript_type("Concurring Opinion - Jackson - June 27, 2024")
        assert result == ("concurrence", "Jackson")

    def test_opinion_with_part(self) -> None:
        """Opinion with part number returns opinion type."""
        result = parse_transcript_type("Opinion Announcement - June 29, 2015 (Part 1)")
        assert result == ("opinion", None)

    def test_unknown_format(self) -> None:
        """Unknown format returns unknown type."""
        result = parse_transcript_type("Some Unknown Title")
        assert result == ("unknown", None)


class TestProcessedTurn:
    """Tests for ProcessedTurn dataclass."""

    def test_from_raw_valid(self) -> None:
        """Turn with positive duration and text is valid."""
        raw_turn = {
            "start": 0.0,
            "stop": 7.82,
            "speaker": {
                "ID": 15086,
                "name": "John G. Roberts, Jr.",
            },
            "text_blocks": [
                {"start": 0.0, "stop": 7.82, "text": "We'll hear argument next."}
            ],
        }
        turn = ProcessedTurn.from_raw(raw_turn, index=0, section_index=0)

        assert turn.index == 0
        assert turn.section_index == 0
        assert turn.start == 0.0
        assert turn.stop == 7.82
        assert turn.duration == 7.82
        assert turn.speaker_id == 15086
        assert turn.speaker_name == "John G. Roberts, Jr."
        assert turn.is_valid is True
        assert turn.text == "We'll hear argument next."
        assert turn.char_count == 25
        assert turn.word_count == 4

    def test_invalid_negative_duration(self) -> None:
        """Turn with stop < start is invalid."""
        raw_turn = {
            "start": 100.0,
            "stop": 50.0,  # Negative duration
            "speaker": {"ID": 1, "name": "Speaker"},
            "text_blocks": [{"text": "Some text"}],
        }
        turn = ProcessedTurn.from_raw(raw_turn, index=0, section_index=0)

        assert turn.is_valid is False
        assert turn.duration == -50.0

    def test_invalid_zero_duration(self) -> None:
        """Turn with zero duration is invalid."""
        raw_turn = {
            "start": 100.0,
            "stop": 100.0,
            "speaker": {"ID": 1, "name": "Speaker"},
            "text_blocks": [{"text": "Some text"}],
        }
        turn = ProcessedTurn.from_raw(raw_turn, index=0, section_index=0)

        assert turn.is_valid is False

    def test_invalid_empty_text(self) -> None:
        """Turn with empty text is invalid."""
        raw_turn = {
            "start": 0.0,
            "stop": 5.0,
            "speaker": {"ID": 1, "name": "Speaker"},
            "text_blocks": [{"text": "   "}],
        }
        turn = ProcessedTurn.from_raw(raw_turn, index=0, section_index=0)

        assert turn.is_valid is False

    def test_null_speaker(self) -> None:
        """Turn with null speaker is handled."""
        raw_turn = {
            "start": 0.0,
            "stop": 5.0,
            "speaker": None,
            "text_blocks": [{"text": "Unattributed speech"}],
        }
        turn = ProcessedTurn.from_raw(raw_turn, index=0, section_index=0)

        assert turn.speaker_id is None
        assert turn.speaker_name is None
        assert turn.is_valid is True

    def test_multiple_text_blocks(self) -> None:
        """Turn with multiple text blocks concatenates text."""
        raw_turn = {
            "start": 0.0,
            "stop": 10.0,
            "speaker": {"ID": 1, "name": "Speaker"},
            "text_blocks": [
                {"text": "First block."},
                {"text": "Second block."},
            ],
        }
        turn = ProcessedTurn.from_raw(raw_turn, index=0, section_index=0)

        assert turn.text == "First block. Second block."
        assert turn.text_block_count == 2

    def test_word_count(self) -> None:
        """Verify word counting."""
        raw_turn = {
            "start": 0.0,
            "stop": 5.0,
            "speaker": {"ID": 1, "name": "Speaker"},
            "text_blocks": [{"text": "One two three four five"}],
        }
        turn = ProcessedTurn.from_raw(raw_turn, index=0, section_index=0)

        assert turn.word_count == 5

    def test_to_dict(self) -> None:
        """to_dict returns correct structure."""
        raw_turn = {
            "start": 0.0,
            "stop": 5.0,
            "speaker": {"ID": 1, "name": "Speaker"},
            "text_blocks": [{"text": "Hello world"}],
        }
        turn = ProcessedTurn.from_raw(raw_turn, index=0, section_index=0)
        result = turn.to_dict()

        assert result["index"] == 0
        assert result["start"] == 0.0
        assert result["stop"] == 5.0
        assert result["duration"] == 5.0
        assert result["speaker_id"] == 1
        assert result["speaker_name"] == "Speaker"
        assert result["is_valid"] is True
        assert result["text"] == "Hello world"
