# Generated by Claude
"""Tests for stats CLI commands."""

import json
import re
import tempfile
from pathlib import Path

from typer.testing import CliRunner

from oyez_sa_asr.cli import app

runner = CliRunner()


def _strip_ansi(text: str) -> str:
    """Remove ANSI escape codes from text."""
    ansi_pattern = re.compile(r"\x1b\[[0-9;]*m")
    return ansi_pattern.sub("", text)


class TestStatsAudio:
    """Tests for stats audio command."""

    def test_help(self) -> None:
        """Shows help."""
        result = runner.invoke(app, ["stats", "audio", "--help"])
        assert result.exit_code == 0
        assert "audio" in result.output.lower()

    def test_no_recordings(self) -> None:
        """Shows message when no recordings found."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            (data_dir / "audio").mkdir()

            result = runner.invoke(app, ["stats", "audio", "--data-dir", str(data_dir)])
            assert result.exit_code == 0
            assert "No recordings found" in result.output

    def test_missing_directory(self) -> None:
        """Fails if audio directory doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = runner.invoke(
                app, ["stats", "audio", "--data-dir", str(Path(tmpdir) / "missing")]
            )
            assert result.exit_code == 1
            assert "not found" in result.output

    def test_displays_stats(self) -> None:
        """Displays audio statistics."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            audio_dir = data_dir / "audio" / "2024" / "22-123"
            audio_dir.mkdir(parents=True)

            # Create metadata and flac file
            meta = {
                "duration": 3600.0,
                "sample_rate": 16000,
                "channels": 1,
                "source_format": "mp3",
                "source_era": "digital",
            }
            (audio_dir / "rec.metadata.json").write_text(json.dumps(meta))
            (audio_dir / "rec.flac").write_bytes(b"fake" * 1000)

            result = runner.invoke(app, ["stats", "audio", "--data-dir", str(data_dir)])
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Audio Statistics" in output
            assert "Total recordings: 1" in output
            assert "digital" in output
            assert "mp3" in output

    def test_term_filter(self) -> None:
        """Filters by term."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)

            # Create two terms
            for term in ["2023", "2024"]:
                audio_dir = data_dir / "audio" / term / "docket"
                audio_dir.mkdir(parents=True)
                meta = {
                    "duration": 100.0,
                    "source_format": "mp3",
                    "source_era": "digital",
                }
                (audio_dir / "rec.metadata.json").write_text(json.dumps(meta))
                (audio_dir / "rec.flac").write_bytes(b"fake")

            result = runner.invoke(
                app, ["stats", "audio", "--data-dir", str(data_dir), "--term", "2024"]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Total recordings: 1" in output


class TestStatsTranscripts:
    """Tests for stats transcripts command."""

    def test_help(self) -> None:
        """Shows help."""
        result = runner.invoke(app, ["stats", "transcripts", "--help"])
        assert result.exit_code == 0
        assert "transcript" in result.output.lower()

    def test_no_transcripts(self) -> None:
        """Shows message when no transcripts found."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            (data_dir / "transcripts").mkdir()

            result = runner.invoke(
                app, ["stats", "transcripts", "--data-dir", str(data_dir)]
            )
            assert result.exit_code == 0
            assert "No transcripts found" in result.output

    def test_missing_directory(self) -> None:
        """Fails if transcripts directory doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = runner.invoke(
                app,
                ["stats", "transcripts", "--data-dir", str(Path(tmpdir) / "missing")],
            )
            assert result.exit_code == 1
            assert "not found" in result.output

    def test_displays_stats(self) -> None:
        """Displays transcript statistics."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            trans_dir = data_dir / "transcripts" / "2024" / "22-123"
            trans_dir.mkdir(parents=True)

            transcript = {
                "type": "argument",
                "turns": [
                    {
                        "is_valid": True,
                        "duration": 10.0,
                        "word_count": 50,
                        "speaker_name": "John Roberts",
                    },
                    {
                        "is_valid": True,
                        "duration": 15.0,
                        "word_count": 75,
                        "speaker_name": "Elena Kagan",
                    },
                ],
            }
            (trans_dir / "argument.json").write_text(json.dumps(transcript))

            result = runner.invoke(
                app, ["stats", "transcripts", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Transcript Statistics" in output
            assert "Total transcripts: 1" in output
            assert "Total turns: 2" in output
            assert "John Roberts" in output
            assert "argument" in output

    def test_term_filter(self) -> None:
        """Filters by term."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)

            for term in ["2023", "2024"]:
                trans_dir = data_dir / "transcripts" / term / "docket"
                trans_dir.mkdir(parents=True)
                transcript = {"type": "argument", "turns": [{"is_valid": True}]}
                (trans_dir / "arg.json").write_text(json.dumps(transcript))

            result = runner.invoke(
                app,
                ["stats", "transcripts", "--data-dir", str(data_dir), "--term", "2024"],
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Total transcripts: 1" in output
