# Generated by Claude
"""Tests for audio segment extraction (TDD RED phase)."""

import tempfile
from pathlib import Path

import numpy as np
import pytest

from oyez_sa_asr.audio_segment import (
    extract_segment,
    extract_segment_from_array,
    extract_segments_batch,
)
from oyez_sa_asr.audio_utils import load_audio, save_audio


def _create_test_audio(duration_sec: float, sample_rate: int = 16000) -> Path:
    """Create a test FLAC audio file with known content."""
    with tempfile.NamedTemporaryFile(suffix=".flac", delete=False) as tmpfile:
        path = Path(tmpfile.name)

    # Create a simple sine wave at 440 Hz
    t = np.linspace(0, duration_sec, int(duration_sec * sample_rate), dtype=np.float32)
    samples = np.sin(2 * np.pi * 440 * t) * 0.5  # 440 Hz sine wave at 50% volume
    samples = samples[np.newaxis, :]  # Shape: (1, num_samples)

    save_audio(samples, sample_rate, path, format="flac", bits_per_sample=16)
    return path


class TestExtractSegment:
    """Tests for extract_segment function."""

    def test_extract_middle_segment(self) -> None:
        """Extract a segment from the middle of the audio."""
        path = _create_test_audio(10.0)
        try:
            segment_bytes = extract_segment(path, start_sec=2.0, end_sec=5.0)
            assert isinstance(segment_bytes, bytes)
            assert len(segment_bytes) > 0

            # Save and reload to verify it's valid FLAC
            with tempfile.NamedTemporaryFile(suffix=".flac", delete=False) as f:
                f.write(segment_bytes)
                segment_path = Path(f.name)

            audio, sr = load_audio(segment_path)
            # Should be approximately 3 seconds
            expected_samples = 3.0 * sr
            assert abs(audio.shape[1] - expected_samples) < sr * 0.1  # 100ms tolerance
            segment_path.unlink()
        finally:
            path.unlink()

    def test_extract_from_start(self) -> None:
        """Extract a segment starting from 0."""
        path = _create_test_audio(5.0)
        try:
            segment_bytes = extract_segment(path, start_sec=0.0, end_sec=2.0)
            assert len(segment_bytes) > 0

            with tempfile.NamedTemporaryFile(suffix=".flac", delete=False) as f:
                f.write(segment_bytes)
                segment_path = Path(f.name)

            audio, sr = load_audio(segment_path)
            expected_samples = 2.0 * sr
            assert abs(audio.shape[1] - expected_samples) < sr * 0.1
            segment_path.unlink()
        finally:
            path.unlink()

    def test_extract_to_end(self) -> None:
        """Extract a segment to the end of the audio."""
        path = _create_test_audio(5.0)
        try:
            segment_bytes = extract_segment(path, start_sec=3.0, end_sec=5.0)
            assert len(segment_bytes) > 0

            with tempfile.NamedTemporaryFile(suffix=".flac", delete=False) as f:
                f.write(segment_bytes)
                segment_path = Path(f.name)

            audio, sr = load_audio(segment_path)
            expected_samples = 2.0 * sr
            assert abs(audio.shape[1] - expected_samples) < sr * 0.1
            segment_path.unlink()
        finally:
            path.unlink()

    def test_extract_returns_valid_flac(self) -> None:
        """Verify extracted bytes are valid FLAC format."""
        path = _create_test_audio(3.0)
        try:
            segment_bytes = extract_segment(path, start_sec=1.0, end_sec=2.0)
            # FLAC files start with "fLaC" magic bytes
            assert segment_bytes[:4] == b"fLaC"
        finally:
            path.unlink()


class TestExtractSegmentValidation:
    """Tests for segment extraction validation."""

    def test_rejects_invalid_time_range(self) -> None:
        """Raises ValueError when start_sec >= end_sec."""
        path = _create_test_audio(5.0)
        try:
            with pytest.raises(ValueError, match="must be <"):
                extract_segment(path, start_sec=3.0, end_sec=2.0)
        finally:
            path.unlink()

    def test_rejects_equal_times(self) -> None:
        """Raises ValueError when start_sec == end_sec."""
        path = _create_test_audio(5.0)
        try:
            with pytest.raises(ValueError, match="must be <"):
                extract_segment(path, start_sec=2.0, end_sec=2.0)
        finally:
            path.unlink()


class TestExtractSegmentFromArray:
    """Tests for extract_segment_from_array function."""

    def test_extract_from_array(self) -> None:
        """Extract segment from pre-loaded audio array."""
        sample_rate = 16000
        duration = 5.0
        samples = np.sin(np.linspace(0, 10 * np.pi, int(duration * sample_rate)))
        samples = samples.astype(np.float32)[np.newaxis, :]

        segment_bytes = extract_segment_from_array(
            samples, sample_rate, start_sec=1.0, end_sec=3.0
        )
        assert isinstance(segment_bytes, bytes)
        assert len(segment_bytes) > 0
        assert segment_bytes[:4] == b"fLaC"

    def test_preserves_sample_rate(self) -> None:
        """Verify segment preserves original sample rate."""
        sample_rate = 44100
        samples = np.zeros((1, sample_rate * 3), dtype=np.float32)  # 3 seconds

        segment_bytes = extract_segment_from_array(
            samples, sample_rate, start_sec=0.0, end_sec=1.0
        )

        with tempfile.NamedTemporaryFile(suffix=".flac", delete=False) as f:
            f.write(segment_bytes)
            segment_path = Path(f.name)

        _, sr = load_audio(segment_path)
        assert sr == sample_rate
        segment_path.unlink()


class TestExtractSegmentsBatch:
    """Tests for batch segment extraction."""

    def test_batch_extraction(self) -> None:
        """Extract multiple segments from one file."""
        path = _create_test_audio(10.0)
        try:
            segments = [(0.0, 2.0), (3.0, 5.0), (7.0, 9.0)]
            result = extract_segments_batch(path, segments)

            assert len(result) == 3
            for segment_bytes in result:
                assert isinstance(segment_bytes, bytes)
                assert len(segment_bytes) > 0
                assert segment_bytes[:4] == b"fLaC"
        finally:
            path.unlink()

    def test_batch_reads_file_once(self) -> None:
        """Verify batch extraction only reads the file once."""
        path = _create_test_audio(10.0)
        try:
            segments = [(0.0, 1.0), (2.0, 3.0), (4.0, 5.0), (6.0, 7.0)]
            # This should be much faster than 4 separate calls
            result = extract_segments_batch(path, segments)
            assert len(result) == 4
        finally:
            path.unlink()

    def test_empty_segments_list(self) -> None:
        """Handle empty segments list."""
        path = _create_test_audio(5.0)
        try:
            result = extract_segments_batch(path, [])
            assert result == []
        finally:
            path.unlink()

    def test_single_segment_batch(self) -> None:
        """Handle single segment in batch."""
        path = _create_test_audio(5.0)
        try:
            result = extract_segments_batch(path, [(1.0, 2.0)])
            assert len(result) == 1
        finally:
            path.unlink()
