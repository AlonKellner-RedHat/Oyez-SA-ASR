# Generated by Claude
"""Tests specific to HuggingFace datasets v3.x (loading scripts with trust_remote_code).

These tests verify that datasets can be loaded via custom loading scripts
using the trust_remote_code=True parameter, which is only supported in v3.x.

The workaround for testing is to load scripts by their file path with data_dir:
    load_dataset("src/oyez_sa_asr/hf_scripts/raw.py", data_dir="datasets/raw", ...)
"""

import pytest

from oyez_sa_asr.hf_compat import is_v4, supports_loading_scripts

pytestmark = pytest.mark.skipif(is_v4(), reason="Requires datasets v3.x")


class TestV3VersionDetection:
    """Tests for version detection in v3.x environment."""

    def test_supports_loading_scripts_returns_true(self) -> None:
        """Verify supports_loading_scripts() returns True in v3.x environment."""
        assert supports_loading_scripts() is True

    def test_is_v4_returns_false(self) -> None:
        """Verify is_v4() returns False in v3.x environment."""
        assert is_v4() is False


class TestV3LoadingScripts:
    """Tests for loading script functionality in v3.x."""

    def test_raw_loads_via_script(self) -> None:
        """Load raw dataset via loading script with trust_remote_code."""
        from datasets import load_dataset  # noqa: PLC0415

        ds = load_dataset(
            "src/oyez_sa_asr/hf_scripts/raw.py",
            data_dir="datasets/raw",
            trust_remote_code=True,
            streaming=True,
        )
        sample = next(iter(ds["train"]))

        # Verify core fields
        assert "recording_id" in sample
        assert "term" in sample
        assert "docket" in sample

        # Verify audio feature (not just path)
        assert "audio" in sample

        # Verify embedded metadata from JSON files
        assert "title" in sample
        assert "case_name" in sample

    def test_flex_recordings_loads_via_script(self) -> None:
        """Load flex recordings config via loading script."""
        from datasets import load_dataset  # noqa: PLC0415

        ds = load_dataset(
            "src/oyez_sa_asr/hf_scripts/flex.py",
            "recordings",
            data_dir="datasets/flex",
            trust_remote_code=True,
            streaming=True,
        )
        sample = next(iter(ds["train"]))

        assert "recording_id" in sample
        assert "audio" in sample
        assert "term" in sample
        assert "duration_sec" in sample

    def test_flex_utterances_with_segment_extraction(self) -> None:
        """Load flex utterances config with on-the-fly segment extraction."""
        from datasets import load_dataset  # noqa: PLC0415

        ds = load_dataset(
            "src/oyez_sa_asr/hf_scripts/flex.py",
            "utterances",
            data_dir="datasets/flex",
            trust_remote_code=True,
            streaming=True,
        )
        sample = next(iter(ds["train"]))

        # Verify utterance fields
        assert "id" in sample
        assert "text" in sample
        assert "speaker_name" in sample
        assert "start_sec" in sample
        assert "end_sec" in sample

        # Verify audio segment was extracted
        assert "audio" in sample
