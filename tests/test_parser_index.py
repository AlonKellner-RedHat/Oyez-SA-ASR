# Generated by Claude
"""Tests for CasesIndex and parse_cached_cases (TDD)."""

import json
import tempfile
from pathlib import Path

from oyez_sa_asr.scraper.parser import CasesIndex, CaseSummary, parse_cached_cases


class TestCasesIndex:
    """Tests for CasesIndex dataclass."""

    def test_creation(self) -> None:
        """Should create index with cases."""
        cases = [
            CaseSummary(
                id=1,
                name="Case 1",
                href="https://example.com/a",
                docket_number="1",
                term="2020",
                citation=None,
                timeline=[],
                question=None,
                description=None,
                justia_url=None,
            ),
            CaseSummary(
                id=2,
                name="Case 2",
                href="https://example.com/b",
                docket_number="2",
                term="2020",
                citation=None,
                timeline=[],
                question=None,
                description=None,
                justia_url=None,
            ),
        ]
        index = CasesIndex(cases=cases)
        assert index.total_cases == 2

    def test_to_dict(self) -> None:
        """Should serialize to dict with metadata."""
        cases = [
            CaseSummary(
                id=1,
                name="Case 1",
                href="https://example.com/a",
                docket_number="1",
                term="2020",
                citation=None,
                timeline=[],
                question=None,
                description=None,
                justia_url=None,
            ),
        ]
        index = CasesIndex(cases=cases)
        result = index.to_dict()
        assert "generated_at" in result
        assert result["total_cases"] == 1

    def test_save_to_file(self) -> None:
        """Should save index to JSON file."""
        cases = [
            CaseSummary(
                id=1,
                name="Case 1",
                href="https://example.com/a",
                docket_number="1",
                term="2020",
                citation=None,
                timeline=[],
                question=None,
                description=None,
                justia_url=None,
            ),
        ]
        index = CasesIndex(cases=cases)

        with tempfile.TemporaryDirectory() as tmpdir:
            output_path = Path(tmpdir) / "index.json"
            index.save(output_path)
            assert output_path.exists()
            with output_path.open() as f:
                data = json.load(f)
            assert data["total_cases"] == 1


class TestParseCachedCases:
    """Tests for parse_cached_cases function."""

    def test_parse_single_page(self) -> None:
        """Should parse a single cached page."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir)
            raw_dir = cache_dir / "api.oyez.org" / "raw"
            raw_dir.mkdir(parents=True)

            cases_data = [
                {
                    "ID": 1,
                    "name": "Case 1",
                    "href": "https://api.oyez.org/cases/2020/1",
                    "docket_number": "1",
                    "term": "2020",
                    "citation": {"volume": "1", "page": "1", "year": "2020"},
                    "timeline": [],
                    "question": None,
                    "description": None,
                    "justia_url": None,
                }
            ]
            (raw_dir / "page1.json").write_text(json.dumps(cases_data))

            index = parse_cached_cases(cache_dir)
            assert index.total_cases == 1
            assert index.cases[0].id == 1

    def test_parse_multiple_pages(self) -> None:
        """Should combine cases from multiple cached pages."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir)
            raw_dir = cache_dir / "api.oyez.org" / "raw"
            raw_dir.mkdir(parents=True)

            (raw_dir / "page1.json").write_text(
                json.dumps(
                    [
                        {
                            "ID": 1,
                            "name": "Case 1",
                            "href": "https://example.com/a",
                            "docket_number": "1",
                            "term": "2020",
                            "citation": None,
                            "timeline": [],
                            "question": None,
                            "description": None,
                            "justia_url": None,
                        }
                    ]
                )
            )
            (raw_dir / "page2.json").write_text(
                json.dumps(
                    [
                        {
                            "ID": 2,
                            "name": "Case 2",
                            "href": "https://example.com/b",
                            "docket_number": "2",
                            "term": "2020",
                            "citation": None,
                            "timeline": [],
                            "question": None,
                            "description": None,
                            "justia_url": None,
                        }
                    ]
                )
            )

            index = parse_cached_cases(cache_dir)
            assert index.total_cases == 2

    def test_skip_empty_responses(self) -> None:
        """Should skip empty array responses."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir)
            raw_dir = cache_dir / "api.oyez.org" / "raw"
            raw_dir.mkdir(parents=True)

            (raw_dir / "page1.json").write_text(
                json.dumps(
                    [
                        {
                            "ID": 1,
                            "name": "Case 1",
                            "href": "https://example.com/a",
                            "docket_number": "1",
                            "term": "2020",
                            "citation": None,
                            "timeline": [],
                            "question": None,
                            "description": None,
                            "justia_url": None,
                        }
                    ]
                )
            )
            (raw_dir / "empty.json").write_text(json.dumps([]))

            index = parse_cached_cases(cache_dir)
            assert index.total_cases == 1

    def test_empty_cache_returns_empty_index(self) -> None:
        """Should return empty index when no cached files exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir)
            index = parse_cached_cases(cache_dir)
            assert index.total_cases == 0
