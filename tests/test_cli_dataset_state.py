# Generated by Claude
"""Tests for dataset state management."""

import json
from pathlib import Path

from oyez_sa_asr.cli_dataset_state import (
    SCHEMA_VERSION,
    DatasetState,
    check_match,
    clean_dataset,
    load_state,
    make_state,
    save_state,
)


class TestDatasetState:
    """Tests for DatasetState dataclass."""

    def test_to_dict(self) -> None:
        """Test conversion to dictionary."""
        state = DatasetState(
            version=1,
            terms=["2022", "2023"],
            completed=True,
            created_by="test",
            settings={"shard_size_mb": 500},
        )
        result = state.to_dict()
        assert result == {
            "version": 1,
            "terms": ["2022", "2023"],
            "completed": True,
            "created_by": "test",
            "settings": {"shard_size_mb": 500},
        }

    def test_from_dict(self) -> None:
        """Test creation from dictionary."""
        data = {
            "version": 1,
            "terms": ["2022"],
            "completed": True,
            "created_by": "test",
            "settings": {},
        }
        state = DatasetState.from_dict(data)
        assert state.version == 1
        assert state.terms == ["2022"]
        assert state.completed is True
        assert state.created_by == "test"

    def test_from_dict_with_defaults(self) -> None:
        """Test from_dict handles missing fields."""
        state = DatasetState.from_dict({})
        assert state.version == 0
        assert state.terms == []
        assert state.completed is False
        assert state.created_by == ""
        assert state.settings == {}


class TestLoadState:
    """Tests for load_state function."""

    def test_returns_none_if_no_index(self, tmp_path: Path) -> None:
        """Test returns None when index.json doesn't exist."""
        assert load_state(tmp_path) is None

    def test_loads_valid_index(self, tmp_path: Path) -> None:
        """Test loading a valid index.json."""
        index = {
            "version": 1,
            "terms": ["2022"],
            "completed": True,
            "created_by": "test",
            "settings": {},
        }
        (tmp_path / "index.json").write_text(json.dumps(index))

        state = load_state(tmp_path)
        assert state is not None
        assert state.version == 1
        assert state.terms == ["2022"]
        assert state.completed is True

    def test_returns_none_for_invalid_json(self, tmp_path: Path) -> None:
        """Test returns None for invalid JSON."""
        (tmp_path / "index.json").write_text("not valid json")
        assert load_state(tmp_path) is None


class TestCheckMatch:
    """Tests for check_match function."""

    def test_no_match_if_existing_none(self) -> None:
        """Test no match when existing state is None."""
        current = make_state("test", ["2022"])
        assert check_match(current, None) is False

    def test_no_match_if_version_differs(self) -> None:
        """Test no match when version differs."""
        current = make_state("test", ["2022"])
        existing = DatasetState(
            version=0, terms=["2022"], completed=True, created_by="test", settings={}
        )
        assert check_match(current, existing) is False

    def test_no_match_if_terms_differ(self) -> None:
        """Test no match when terms differ."""
        current = make_state("test", ["2022", "2023"])
        existing = DatasetState(
            version=SCHEMA_VERSION,
            terms=["2022"],
            completed=True,
            created_by="test",
            settings={},
        )
        assert check_match(current, existing) is False

    def test_no_match_if_settings_differ(self) -> None:
        """Test no match when settings differ."""
        current = make_state("test", ["2022"], shard_size_mb=500)
        existing = DatasetState(
            version=SCHEMA_VERSION,
            terms=["2022"],
            completed=True,
            created_by="test",
            settings={"shard_size_mb": 250},
        )
        assert check_match(current, existing) is False

    def test_no_match_if_incomplete(self) -> None:
        """Test no match when completed is False."""
        current = make_state("test", ["2022"])
        existing = DatasetState(
            version=SCHEMA_VERSION,
            terms=["2022"],
            completed=False,
            created_by="test",
            settings={},
        )
        assert check_match(current, existing) is False

    def test_match_with_identical_settings(self) -> None:
        """Test match when everything matches."""
        current = make_state("test", ["2022", "2023"])
        existing = DatasetState(
            version=SCHEMA_VERSION,
            terms=["2022", "2023"],
            completed=True,
            created_by="test",
            settings={},
        )
        assert check_match(current, existing) is True

    def test_match_ignores_term_order(self) -> None:
        """Test match ignores order of terms."""
        current = make_state("test", ["2023", "2022"])
        existing = DatasetState(
            version=SCHEMA_VERSION,
            terms=["2022", "2023"],
            completed=True,
            created_by="test",
            settings={},
        )
        assert check_match(current, existing) is True


class TestCleanDataset:
    """Tests for clean_dataset function."""

    def test_returns_zero_for_nonexistent(self, tmp_path: Path) -> None:
        """Test returns 0 when directory doesn't exist."""
        nonexistent = tmp_path / "nonexistent"
        assert clean_dataset(nonexistent) == 0

    def test_removes_all_files(self, tmp_path: Path) -> None:
        """Test removes all files and returns count."""
        dataset_dir = tmp_path / "dataset"
        dataset_dir.mkdir()
        (dataset_dir / "index.json").write_text("{}")
        (dataset_dir / "data").mkdir()
        (dataset_dir / "data" / "file1.parquet").write_bytes(b"data")
        (dataset_dir / "data" / "file2.parquet").write_bytes(b"data")

        count = clean_dataset(dataset_dir)
        assert count == 3
        assert not dataset_dir.exists()


class TestSaveState:
    """Tests for save_state function."""

    def test_creates_directory_and_file(self, tmp_path: Path) -> None:
        """Test creates directory and writes index.json."""
        output_dir = tmp_path / "new_dataset"
        state = make_state("test", ["2022"], completed=True)

        save_state(output_dir, state)

        assert output_dir.exists()
        index = json.loads((output_dir / "index.json").read_text())
        assert index["version"] == SCHEMA_VERSION
        assert index["terms"] == ["2022"]
        assert index["completed"] is True


class TestMakeState:
    """Tests for make_state helper."""

    def test_uses_current_schema_version(self) -> None:
        """Test uses current schema version."""
        state = make_state("test", ["2022"])
        assert state.version == SCHEMA_VERSION

    def test_sorts_terms(self) -> None:
        """Test sorts terms."""
        state = make_state("test", ["2023", "2022", "2021"])
        assert state.terms == ["2021", "2022", "2023"]

    def test_handles_none_terms(self) -> None:
        """Test handles None terms."""
        state = make_state("test", None)
        assert state.terms == []

    def test_accepts_settings_kwargs(self) -> None:
        """Test accepts arbitrary settings."""
        state = make_state("test", ["2022"], shard_size_mb=500, custom="value")
        assert state.settings == {"shard_size_mb": 500, "custom": "value"}
