# Generated by Claude
"""Tests for process speakers command."""

import json
import re
import tempfile
from pathlib import Path
from typing import TYPE_CHECKING

from typer.testing import CliRunner

from oyez_sa_asr.cli import app
from oyez_sa_asr.cli_process_speakers import (
    _load_case_names,
    _process_transcript_file,
)

if TYPE_CHECKING:
    from oyez_sa_asr.speaker_models import SpeakerProfile

runner = CliRunner()


def _strip_ansi(text: str) -> str:
    """Strip ANSI escape codes from a string."""
    return re.sub(r"\x1b\[[0-9;]*m", "", text)


def _create_transcript(
    term: str,
    docket: str,
    transcript_type: str = "oral_argument",
    turns: list[dict] | None = None,
) -> dict:
    """Create a mock transcript structure."""
    if turns is None:
        turns = [
            {
                "index": 0,
                "speaker_id": 123,
                "speaker_name": "Justice Smith",
                "start": 0.0,
                "stop": 10.0,
                "duration": 10.0,
                "is_valid": True,
                "word_count": 50,
                "text": "This is a test.",
            },
            {
                "index": 1,
                "speaker_id": 456,
                "speaker_name": "Mr. Jones",
                "start": 10.0,
                "stop": 20.0,
                "duration": 10.0,
                "is_valid": True,
                "word_count": 60,
                "text": "Response to the test.",
            },
        ]
    return {
        "id": 1,
        "case_docket": docket,
        "term": term,
        "type": transcript_type,
        "title": "Oral Argument",
        "metadata": {"duration_seconds": 100.0},
        "turns": turns,
    }


def _create_case(term: str, docket: str, name: str = "Test v. Case") -> dict:
    """Create a mock case structure."""
    return {
        "id": 1,
        "name": name,
        "docket_number": docket,
        "term": term,
        "href": f"https://api.oyez.org/cases/{term}/{docket}",
    }


class TestProcessSpeakersHelp:
    """Tests for help output."""

    def test_help(self) -> None:
        """Shows help message."""
        result = runner.invoke(app, ["process", "speakers", "--help"])
        assert result.exit_code == 0
        assert "speakers" in result.output.lower()


class TestProcessSpeakersMissingData:
    """Tests for missing data handling."""

    def test_missing_transcripts_dir(self) -> None:
        """Fails gracefully when transcripts directory doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(Path(tmpdir) / "missing"),
                    "--output-dir",
                    str(Path(tmpdir) / "output"),
                ],
            )
            output = _strip_ansi(result.output)
            assert "not found" in output.lower() or "no transcripts" in output.lower()


class TestProcessSpeakersBasic:
    """Tests for basic speaker processing."""

    def test_processes_speakers_from_transcripts(self) -> None:
        """Aggregates speakers from transcript files."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)

            # Create transcripts directory structure
            transcripts_dir = data_dir / "transcripts" / "2024" / "23-1234"
            transcripts_dir.mkdir(parents=True)
            transcript = _create_transcript("2024", "23-1234")
            (transcripts_dir / "oral_argument.json").write_text(json.dumps(transcript))

            # Create cases directory for case names
            cases_dir = data_dir / "cases" / "2024"
            cases_dir.mkdir(parents=True)
            case = _create_case("2024", "23-1234", "Smith v. Jones")
            (cases_dir / "23-1234.json").write_text(json.dumps(case))

            output_dir = data_dir / "speakers"

            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(data_dir / "transcripts"),
                    "--cases-dir",
                    str(data_dir / "cases"),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            output = _strip_ansi(result.output)
            assert "processed" in output.lower() or "done" in output.lower()

            # Check output files exist in subdirectories
            other_files = list((output_dir / "other").glob("*.json"))
            assert len(other_files) == 2  # Both are "other" with few appearances

            # Check Justice Smith file (in other/ since only 1 case)
            smith_file = output_dir / "other" / "123_justice_smith.json"
            assert smith_file.exists()
            with smith_file.open() as f:
                smith_data = json.load(f)
            assert smith_data["id"] == 123
            assert smith_data["name"] == "Justice Smith"
            assert smith_data["role"] == "other"  # Not enough cases to detect
            assert smith_data["totals"]["turns"] == 1

            # Check Mr. Jones file
            jones_file = output_dir / "other" / "456_mr_jones.json"
            assert jones_file.exists()
            with jones_file.open() as f:
                jones_data = json.load(f)
            assert jones_data["role"] == "other"


class TestProcessSpeakersAggregation:
    """Tests for speaker aggregation across multiple recordings."""

    def test_aggregates_across_multiple_transcripts(self) -> None:
        """Combines speaker data from multiple transcripts."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            transcripts_dir = data_dir / "transcripts"
            cases_dir = data_dir / "cases"
            output_dir = data_dir / "speakers"

            # Create two transcripts with same speaker
            for docket in ["23-1234", "23-5678"]:
                t_dir = transcripts_dir / "2024" / docket
                t_dir.mkdir(parents=True)
                transcript = _create_transcript(
                    "2024",
                    docket,
                    turns=[
                        {
                            "index": 0,
                            "speaker_id": 123,
                            "speaker_name": "Justice Smith",
                            "start": 0.0,
                            "stop": 10.0,
                            "duration": 10.0,
                            "is_valid": True,
                            "word_count": 50,
                            "text": "Test.",
                        }
                    ],
                )
                (t_dir / "oral_argument.json").write_text(json.dumps(transcript))

                c_dir = cases_dir / "2024"
                c_dir.mkdir(parents=True, exist_ok=True)
                case = _create_case("2024", docket)
                (c_dir / f"{docket}.json").write_text(json.dumps(case))

            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(transcripts_dir),
                    "--cases-dir",
                    str(cases_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0

            # Check aggregated totals (in other/ since only 2 cases)
            smith_file = output_dir / "other" / "123_justice_smith.json"
            with smith_file.open() as f:
                smith_data = json.load(f)

            assert smith_data["totals"]["recordings"] == 2
            assert smith_data["totals"]["cases"] == 2
            assert smith_data["totals"]["turns"] == 2


class TestProcessSpeakersTermFilter:
    """Tests for term filtering."""

    def test_filters_by_term(self) -> None:
        """Only processes specified terms."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            transcripts_dir = data_dir / "transcripts"
            cases_dir = data_dir / "cases"
            output_dir = data_dir / "speakers"

            # Create transcripts for two terms
            for term in ["2023", "2024"]:
                t_dir = transcripts_dir / term / "docket"
                t_dir.mkdir(parents=True)
                transcript = _create_transcript(term, "docket")
                (t_dir / "oral_argument.json").write_text(json.dumps(transcript))

                c_dir = cases_dir / term
                c_dir.mkdir(parents=True)
                case = _create_case(term, "docket")
                (c_dir / "docket.json").write_text(json.dumps(case))

            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(transcripts_dir),
                    "--cases-dir",
                    str(cases_dir),
                    "--output-dir",
                    str(output_dir),
                    "--term",
                    "2024",
                ],
            )

            assert result.exit_code == 0

            # Check only 2024 data was processed (in other/ since only 1 case)
            smith_file = output_dir / "other" / "123_justice_smith.json"
            with smith_file.open() as f:
                smith_data = json.load(f)

            assert "2024" in smith_data["by_term"]
            assert "2023" not in smith_data["by_term"]

    def test_process_speakers_with_force(self) -> None:
        """Should regenerate speaker files when --force is used."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            transcripts_dir = data_dir / "transcripts" / "2024" / "23-1234"
            transcripts_dir.mkdir(parents=True)
            transcript = _create_transcript("2024", "23-1234")
            (transcripts_dir / "oral_argument.json").write_text(json.dumps(transcript))

            cases_dir = data_dir / "cases" / "2024"
            cases_dir.mkdir(parents=True)
            case = _create_case("2024", "23-1234")
            (cases_dir / "23-1234.json").write_text(json.dumps(case))

            output_dir = data_dir / "speakers"

            # Process once
            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(data_dir / "transcripts"),
                    "--cases-dir",
                    str(data_dir / "cases"),
                    "--output-dir",
                    str(output_dir),
                ],
            )
            assert result.exit_code == 0
            smith_file = output_dir / "other" / "123_justice_smith.json"
            assert smith_file.exists()

            # Process again with --force
            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(data_dir / "transcripts"),
                    "--cases-dir",
                    str(data_dir / "cases"),
                    "--output-dir",
                    str(output_dir),
                    "--force",
                ],
            )
            assert result.exit_code == 0
            assert (
                "Force mode" in result.output or "regenerating" in result.output.lower()
            )

    def test_process_speakers_skips_existing(self) -> None:
        """Should skip existing files when --force is not used."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            transcripts_dir = data_dir / "transcripts" / "2024" / "23-1234"
            transcripts_dir.mkdir(parents=True)
            transcript = _create_transcript("2024", "23-1234")
            (transcripts_dir / "oral_argument.json").write_text(json.dumps(transcript))

            cases_dir = data_dir / "cases" / "2024"
            cases_dir.mkdir(parents=True)
            case = _create_case("2024", "23-1234")
            (cases_dir / "23-1234.json").write_text(json.dumps(case))

            output_dir = data_dir / "speakers"

            # Process once
            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(data_dir / "transcripts"),
                    "--cases-dir",
                    str(data_dir / "cases"),
                    "--output-dir",
                    str(output_dir),
                ],
            )
            assert result.exit_code == 0

            # Process again without --force
            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(data_dir / "transcripts"),
                    "--cases-dir",
                    str(data_dir / "cases"),
                    "--output-dir",
                    str(output_dir),
                ],
            )
            assert result.exit_code == 0
            output = _strip_ansi(result.output)
            assert "Skipped (existing)" in output

    def test_process_speakers_no_transcripts(self) -> None:
        """Should handle case when no transcripts are found."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            transcripts_dir = data_dir / "transcripts"
            transcripts_dir.mkdir(parents=True)
            # Create empty term directory
            (transcripts_dir / "2024").mkdir()

            cases_dir = data_dir / "cases"
            output_dir = data_dir / "speakers"

            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(transcripts_dir),
                    "--cases-dir",
                    str(cases_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            assert "No transcripts found" in result.output

    def test_process_speakers_invalid_json(self) -> None:
        """Should handle invalid JSON in transcript files."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            transcripts_dir = data_dir / "transcripts" / "2024" / "23-1234"
            transcripts_dir.mkdir(parents=True)
            # Create invalid JSON file
            (transcripts_dir / "oral_argument.json").write_text("invalid json")

            cases_dir = data_dir / "cases"
            output_dir = data_dir / "speakers"

            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(data_dir / "transcripts"),
                    "--cases-dir",
                    str(cases_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            # Should handle error gracefully
            assert (
                "processed" in result.output.lower() or "done" in result.output.lower()
            )

    def test_load_case_names_skips_non_directories(self) -> None:
        """Should skip non-directory entries (lines 32, 42-43)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cases_dir = Path(tmpdir)
            # Create a file (not a directory) in cases_dir
            (cases_dir / "not_a_dir.txt").write_text("test")

            # Create a valid term directory
            term_dir = cases_dir / "2024"
            term_dir.mkdir()
            case = {"term": "2024", "docket_number": "22-123", "name": "Test Case"}
            (term_dir / "22-123.json").write_text(json.dumps(case))

            case_names = _load_case_names(cases_dir, None)
            # Should only extract from valid directories, skip non-directories
            assert "2024/22-123" in case_names
            assert case_names["2024/22-123"] == "Test Case"

    def test_load_case_names_handles_exceptions(self) -> None:
        """Should handle JSONDecodeError, KeyError (line 42-43)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cases_dir = Path(tmpdir)
            term_dir = cases_dir / "2024"
            term_dir.mkdir()

            # Create invalid JSON file
            (term_dir / "invalid.json").write_text("{ invalid json }")

            # Create file with missing keys
            incomplete = {"id": 1}  # Missing term, docket_number, name
            (term_dir / "incomplete.json").write_text(json.dumps(incomplete))

            # Create valid case file
            case = {"term": "2024", "docket_number": "22-123", "name": "Test Case"}
            (term_dir / "valid.json").write_text(json.dumps(case))

            case_names = _load_case_names(cases_dir, None)
            # Should handle exceptions gracefully and only extract from valid file
            assert "2024/22-123" in case_names

    def test_process_transcript_file_skips_invalid_turns(self) -> None:
        """Should skip invalid turns (lines 74, 78)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            transcript_file = Path(tmpdir) / "transcript.json"
            transcript = {
                "term": "2024",
                "case_docket": "22-123",
                "turns": [
                    {"is_valid": False, "speaker_id": 123},  # Invalid - should skip
                    {"is_valid": True, "speaker_id": 456},  # Valid
                    {"is_valid": True},  # No speaker_id - should skip
                ],
            }
            transcript_file.write_text(json.dumps(transcript))

            speakers: dict[int, SpeakerProfile] = {}
            case_names = {"2024/22-123": "Test Case"}

            count = _process_transcript_file(transcript_file, speakers, case_names)
            # Should only process the valid turn
            assert count == 1
            assert 456 in speakers
            assert 123 not in speakers

    def test_process_speakers_skips_non_directories(self) -> None:
        """Should skip non-directory entries (lines 173, 176)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            transcripts_dir = data_dir / "transcripts"
            cases_dir = data_dir / "cases"
            output_dir = data_dir / "speakers"

            # Create transcripts_dir first, then a file (not a directory) in it
            transcripts_dir.mkdir(parents=True)
            (transcripts_dir / "not_a_dir.txt").write_text("test")

            # Create a valid term directory with a file (not a directory) inside
            term_dir = transcripts_dir / "2024"
            term_dir.mkdir()
            (term_dir / "not_a_dir.json").write_text("test")

            # Create a valid docket directory
            docket_dir = term_dir / "22-123"
            docket_dir.mkdir()
            transcript = _create_transcript("2024", "22-123")
            (docket_dir / "transcript.json").write_text(json.dumps(transcript))

            cases_dir.mkdir()
            case_dir = cases_dir / "2024"
            case_dir.mkdir()
            case = _create_case("2024", "22-123")
            (case_dir / "22-123.json").write_text(json.dumps(case))

            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(transcripts_dir),
                    "--cases-dir",
                    str(cases_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            # Should only process valid directories, skip non-directories

    def test_process_speakers_skips_existing_in_other_subdir(self) -> None:
        """Should skip existing files in other subdirectory (lines 221-222)."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            transcripts_dir = data_dir / "transcripts" / "2024" / "23-1234"
            transcripts_dir.mkdir(parents=True)
            transcript = _create_transcript("2024", "23-1234")
            (transcripts_dir / "oral_argument.json").write_text(json.dumps(transcript))

            cases_dir = data_dir / "cases" / "2024"
            cases_dir.mkdir(parents=True)
            case = _create_case("2024", "23-1234")
            (cases_dir / "23-1234.json").write_text(json.dumps(case))

            output_dir = data_dir / "speakers"
            other_dir = output_dir / "other"
            other_dir.mkdir(parents=True)

            # Create existing file in other/ directory
            existing_file = other_dir / "123_justice_smith.json"
            existing_file.write_text('{"id": 123, "name": "Justice Smith"}')

            result = runner.invoke(
                app,
                [
                    "process",
                    "speakers",
                    "--transcripts-dir",
                    str(data_dir / "transcripts"),
                    "--cases-dir",
                    str(cases_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            output = _strip_ansi(result.output)
            # Should skip existing file
            assert "Skipped" in output or "skipped" in output.lower()
