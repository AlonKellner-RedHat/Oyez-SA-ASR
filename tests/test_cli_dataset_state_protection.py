# Generated by Claude
"""Tests for state protection in dataset CLI commands."""

import json
import tempfile
from pathlib import Path

from typer.testing import CliRunner

from oyez_sa_asr.cli import app
from oyez_sa_asr.cli_dataset_state import SCHEMA_VERSION, make_state, save_state

runner = CliRunner()


class TestStateProtectionRaw:
    """Tests for state protection in dataset raw command."""

    def test_skips_when_matching_settings(self) -> None:
        """Skip generation when settings match and completed."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            output_dir = Path(tmpdir) / "output"
            cache_dir.mkdir(parents=True)

            state = make_state("oyez dataset raw", ["2024"], completed=True)
            save_state(output_dir, state)
            (output_dir / "marker.txt").write_text("original")

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "raw",
                    "--cache-dir",
                    str(cache_dir),
                    "--output-dir",
                    str(output_dir),
                    "--term",
                    "2024",
                ],
            )

            assert result.exit_code == 0
            assert "Skipping" in result.output
            assert (output_dir / "marker.txt").exists()

    def test_cleans_up_when_terms_differ(self) -> None:
        """Clean and regenerate when terms differ."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            output_dir = Path(tmpdir) / "output"
            (cache_dir / "audio").mkdir(parents=True)

            state = make_state("oyez dataset raw", ["2023"], completed=True)
            save_state(output_dir, state)
            (output_dir / "marker.txt").write_text("should be removed")

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "raw",
                    "--cache-dir",
                    str(cache_dir),
                    "--output-dir",
                    str(output_dir),
                    "--term",
                    "2024",
                ],
            )

            assert result.exit_code == 0
            assert "Cleaning" in result.output
            assert not (output_dir / "marker.txt").exists()

    def test_force_regenerates_matching_settings(self) -> None:
        """Force flag regenerates even with matching settings."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            output_dir = Path(tmpdir) / "output"
            (cache_dir / "audio").mkdir(parents=True)

            state = make_state("oyez dataset raw", ["2024"], completed=True)
            save_state(output_dir, state)
            (output_dir / "marker.txt").write_text("should be removed")

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "raw",
                    "--cache-dir",
                    str(cache_dir),
                    "--output-dir",
                    str(output_dir),
                    "--term",
                    "2024",
                    "--force",
                ],
            )

            assert result.exit_code == 0
            assert "Skipping" not in result.output
            assert not (output_dir / "marker.txt").exists()


class TestStateProtectionFlex:
    """Tests for state protection in dataset flex command."""

    def test_skips_when_matching_settings(self) -> None:
        """Skip generation when settings match and completed."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir) / "data"
            output_dir = Path(tmpdir) / "output"
            data_dir.mkdir(parents=True)

            state = make_state("oyez dataset flex", ["2024"], completed=True)
            save_state(output_dir, state)
            (output_dir / "marker.txt").write_text("original")

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "flex",
                    "--data-dir",
                    str(data_dir),
                    "--output-dir",
                    str(output_dir),
                    "--term",
                    "2024",
                ],
            )

            assert result.exit_code == 0
            assert "Skipping" in result.output
            assert (output_dir / "marker.txt").exists()

    def test_cleans_up_when_version_differs(self) -> None:
        """Clean and regenerate when schema version differs."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir) / "data"
            output_dir = Path(tmpdir) / "output"
            data_dir.mkdir(parents=True)

            old_index = {
                "version": 0,
                "terms": ["2024"],
                "completed": True,
                "created_by": "oyez dataset flex",
                "settings": {},
            }
            output_dir.mkdir(parents=True)
            (output_dir / "index.json").write_text(json.dumps(old_index))
            (output_dir / "marker.txt").write_text("should be removed")

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "flex",
                    "--data-dir",
                    str(data_dir),
                    "--output-dir",
                    str(output_dir),
                    "--term",
                    "2024",
                ],
            )

            assert result.exit_code == 0
            assert "Cleaning" in result.output

            new_index = json.loads((output_dir / "index.json").read_text())
            assert new_index["version"] == SCHEMA_VERSION
