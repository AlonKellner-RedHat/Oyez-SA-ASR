# Generated by Claude
"""Tests for dataset helper functions."""

import json
import tempfile
from pathlib import Path

from oyez_sa_asr.cli_dataset_helpers import (
    load_justice_speaker_ids,
    matches_term,
    require_pyarrow,
)


class TestLoadJusticeSpeakerIds:
    """Tests for load_justice_speaker_ids function."""

    def test_loads_justice_ids(self) -> None:
        """Load justice speaker IDs from justices directory."""
        with tempfile.TemporaryDirectory() as tmpdir:
            speakers_dir = Path(tmpdir) / "speakers"
            justices_dir = speakers_dir / "justices"
            justices_dir.mkdir(parents=True)

            # Create speaker files
            speaker1 = {"id": 100, "name": "Justice A", "role": "justice"}
            speaker2 = {"id": 200, "name": "Justice B", "role": "justice"}
            (justices_dir / "100_justice_a.json").write_text(json.dumps(speaker1))
            (justices_dir / "200_justice_b.json").write_text(json.dumps(speaker2))

            result = load_justice_speaker_ids(speakers_dir)
            assert result == {100, 200}

    def test_returns_empty_when_no_justices_dir(self) -> None:
        """Return empty set when justices directory doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            speakers_dir = Path(tmpdir) / "speakers"
            result = load_justice_speaker_ids(speakers_dir)
            assert result == set()

    def test_handles_invalid_json(self) -> None:
        """Skip files with invalid JSON."""
        with tempfile.TemporaryDirectory() as tmpdir:
            speakers_dir = Path(tmpdir) / "speakers"
            justices_dir = speakers_dir / "justices"
            justices_dir.mkdir(parents=True)

            # Create invalid JSON file
            (justices_dir / "invalid.json").write_text("not json")
            # Create valid file
            speaker = {"id": 100, "name": "Justice A", "role": "justice"}
            (justices_dir / "100_justice_a.json").write_text(json.dumps(speaker))

            result = load_justice_speaker_ids(speakers_dir)
            assert result == {100}

    def test_handles_missing_id_field(self) -> None:
        """Skip files without id field."""
        with tempfile.TemporaryDirectory() as tmpdir:
            speakers_dir = Path(tmpdir) / "speakers"
            justices_dir = speakers_dir / "justices"
            justices_dir.mkdir(parents=True)

            # Create file without id
            speaker = {"name": "Justice A", "role": "justice"}
            (justices_dir / "no_id.json").write_text(json.dumps(speaker))
            # Create valid file
            speaker2 = {"id": 100, "name": "Justice B", "role": "justice"}
            (justices_dir / "100_justice_b.json").write_text(json.dumps(speaker2))

            result = load_justice_speaker_ids(speakers_dir)
            assert result == {100}

    def test_defaults_to_data_speakers(self) -> None:
        """Defaults to data/speakers when speakers_dir is None."""
        # This tests the None check and default path
        # We can't easily test the default path without creating actual files
        # But we can test the None handling
        result = load_justice_speaker_ids(None)
        # Should return empty set if directory doesn't exist
        assert isinstance(result, set)


class TestRequirePyarrow:
    """Tests for require_pyarrow function."""

    def test_returns_pyarrow_modules(self) -> None:
        """Should return pyarrow and pyarrow.parquet modules."""
        pa, pq = require_pyarrow()
        assert pa is not None
        assert pq is not None
        # Verify they are actually pyarrow modules
        assert hasattr(pa, "Table")
        assert hasattr(pq, "write_table")


class TestMatchesTerm:
    """Tests for matches_term function."""

    def test_matches_term_in_set(self) -> None:
        """Should return True when term is in set."""
        with tempfile.TemporaryDirectory() as tmpdir:
            json_file = Path(tmpdir) / "test.json"
            json_file.write_text(json.dumps({"term": "2022"}))

            assert matches_term(json_file, {"2022", "2023"}) is True

    def test_no_match_when_term_not_in_set(self) -> None:
        """Should return False when term is not in set."""
        with tempfile.TemporaryDirectory() as tmpdir:
            json_file = Path(tmpdir) / "test.json"
            json_file.write_text(json.dumps({"term": "2022"}))

            assert matches_term(json_file, {"2023", "2024"}) is False

    def test_handles_invalid_json(self) -> None:
        """Should return False for invalid JSON."""
        with tempfile.TemporaryDirectory() as tmpdir:
            json_file = Path(tmpdir) / "test.json"
            json_file.write_text("invalid json")

            assert matches_term(json_file, {"2022"}) is False

    def test_handles_missing_term_field(self) -> None:
        """Should return False when term field is missing."""
        with tempfile.TemporaryDirectory() as tmpdir:
            json_file = Path(tmpdir) / "test.json"
            json_file.write_text(json.dumps({"other": "value"}))

            assert matches_term(json_file, {"2022"}) is False
