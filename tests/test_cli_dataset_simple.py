# Generated by Claude
"""Tests for dataset simple CLI command."""

import json
import tempfile
from pathlib import Path

import pyarrow as pa
import pyarrow.parquet as pq
from typer.testing import CliRunner

from oyez_sa_asr.cli import app

runner = CliRunner()


class TestDatasetSimple:
    """Tests for dataset simple command."""

    def test_help(self) -> None:
        """Shows help."""
        result = runner.invoke(app, ["dataset", "simple", "--help"])
        assert result.exit_code == 0
        assert "oyez-sa-asr-simple" in result.output

    def test_requires_flex_dataset(self) -> None:
        """Fails if flex dataset doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            flex_dir = Path(tmpdir) / "flex"
            output_dir = Path(tmpdir) / "simple"

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "simple",
                    "--flex-dir",
                    str(flex_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 1
            assert "not found" in result.output

    def test_embeds_audio(self) -> None:
        """Embeds audio bytes into parquet files."""
        with tempfile.TemporaryDirectory() as tmpdir:
            flex_dir = Path(tmpdir) / "flex"
            output_dir = Path(tmpdir) / "simple"

            # Create flex structure
            (flex_dir / "data").mkdir(parents=True)
            (flex_dir / "audio" / "2024" / "22-123").mkdir(parents=True)

            # Create recordings parquet
            recordings = [
                {
                    "term": "2024",
                    "docket": "22-123",
                    "recording_id": "20240101a",
                    "audio_path": "2024/22-123/20240101a.flac",
                }
            ]

            pq.write_table(
                pa.Table.from_pylist(recordings),
                flex_dir / "data" / "recordings.parquet",
            )

            # Create utterances parquet
            utterances = [
                {
                    "term": "2024",
                    "docket": "22-123",
                    "text": "Test utterance",
                    "speaker_name": "Roberts",
                    "start_sec": 0.0,
                    "end_sec": 5.0,
                }
            ]
            pq.write_table(
                pa.Table.from_pylist(utterances),
                flex_dir / "data" / "utterances.parquet",
            )

            # Create fake FLAC file
            flac_path = flex_dir / "audio" / "2024" / "22-123" / "20240101a.flac"
            flac_path.write_bytes(b"fake flac bytes")

            # Create index
            (flex_dir / "index.json").write_text(json.dumps({"terms": ["2024"]}))

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "simple",
                    "--flex-dir",
                    str(flex_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            assert (output_dir / "data" / "utterances").exists()
            assert (output_dir / "index.json").exists()
