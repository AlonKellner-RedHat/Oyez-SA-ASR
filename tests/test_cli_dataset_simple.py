# Generated by Claude
"""Tests for dataset simple CLI command - basic tests."""

import json
import tempfile
from pathlib import Path

import numpy as np
import pyarrow as pa
import pyarrow.parquet as pq
from typer.testing import CliRunner

from oyez_sa_asr.audio_utils import save_audio
from oyez_sa_asr.cli import app
from oyez_sa_asr.cli_dataset_simple import _group_utterances_by_recording

runner = CliRunner()


def _create_test_flac(path: Path, duration_sec: float = 10.0) -> None:
    """Create a test FLAC audio file."""
    sample_rate = 16000
    t = np.linspace(0, duration_sec, int(duration_sec * sample_rate), dtype=np.float32)
    samples = np.sin(2 * np.pi * 440 * t) * 0.5
    samples = samples[np.newaxis, :]
    path.parent.mkdir(parents=True, exist_ok=True)
    save_audio(samples, sample_rate, path, format="flac", bits_per_sample=16)


class TestDatasetSimple:
    """Tests for dataset simple command."""

    def test_help(self) -> None:
        """Shows help."""
        result = runner.invoke(app, ["dataset", "simple", "--help"])
        assert result.exit_code == 0
        assert "oyez-sa-asr-simple" in result.output

    def test_requires_flex_dataset(self) -> None:
        """Fails if flex dataset doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            flex_dir = Path(tmpdir) / "flex"
            output_dir = Path(tmpdir) / "simple"

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "simple",
                    "--flex-dir",
                    str(flex_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 1
            assert "not found" in result.output

    def test_embeds_audio(self) -> None:
        """Embeds audio bytes into parquet files."""
        with tempfile.TemporaryDirectory() as tmpdir:
            flex_dir = Path(tmpdir) / "flex"
            output_dir = Path(tmpdir) / "simple"

            (flex_dir / "data").mkdir(parents=True)
            (flex_dir / "audio" / "2024" / "22-123").mkdir(parents=True)

            recordings = [
                {
                    "term": "2024",
                    "docket": "22-123",
                    "recording_id": "20240101a",
                    "audio_path": "2024/22-123/20240101a.flac",
                }
            ]

            pq.write_table(
                pa.Table.from_pylist(recordings),
                flex_dir / "data" / "recordings.parquet",
            )

            utterances = [
                {
                    "term": "2024",
                    "docket": "22-123",
                    "transcript_type": "oral_argument",
                    "text": "Test utterance one",
                    "word_count": 3,
                    "speaker_name": "Roberts",
                    "start_sec": 0.0,
                    "end_sec": 3.0,
                    "duration_sec": 3.0,
                },
                {
                    "term": "2024",
                    "docket": "22-123",
                    "transcript_type": "oral_argument",
                    "text": "Test utterance two",
                    "word_count": 3,
                    "speaker_name": "Sotomayor",
                    "start_sec": 5.0,
                    "end_sec": 8.0,
                    "duration_sec": 3.0,
                },
            ]
            pq.write_table(
                pa.Table.from_pylist(utterances),
                flex_dir / "data" / "utterances.parquet",
            )

            flac_path = flex_dir / "audio" / "2024" / "22-123" / "20240101a.flac"
            _create_test_flac(flac_path, duration_sec=10.0)

            (flex_dir / "index.json").write_text(json.dumps({"terms": ["2024"]}))

            result = runner.invoke(
                app,
                [
                    "dataset",
                    "simple",
                    "--flex-dir",
                    str(flex_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            assert (output_dir / "data" / "utterances").exists()
            assert (output_dir / "index.json").exists()


class TestGroupUtterancesByRecording:
    """Tests for utterance grouping logic."""

    def test_groups_by_term_docket(self) -> None:
        """Groups utterances by (term, docket) key."""
        utterances = [
            {"term": "2024", "docket": "22-123", "text": "a", "start_sec": 0.0},
            {"term": "2024", "docket": "22-123", "text": "b", "start_sec": 5.0},
            {"term": "2024", "docket": "22-456", "text": "c", "start_sec": 0.0},
            {"term": "2023", "docket": "21-789", "text": "d", "start_sec": 0.0},
        ]

        grouped = _group_utterances_by_recording(utterances)

        assert len(grouped) == 3
        assert len(grouped[("2024", "22-123")]) == 2
        assert len(grouped[("2024", "22-456")]) == 1
        assert len(grouped[("2023", "21-789")]) == 1

    def test_preserves_utterance_data(self) -> None:
        """Preserves all utterance fields when grouping."""
        utterances = [
            {
                "term": "2024",
                "docket": "22-123",
                "text": "hello",
                "speaker_name": "Roberts",
                "start_sec": 1.0,
                "end_sec": 3.5,
            }
        ]

        grouped = _group_utterances_by_recording(utterances)

        utt = grouped[("2024", "22-123")][0]
        assert utt["text"] == "hello"
        assert utt["speaker_name"] == "Roberts"
        assert utt["start_sec"] == 1.0
        assert utt["end_sec"] == 3.5

    def test_empty_list(self) -> None:
        """Handles empty utterances list."""
        grouped = _group_utterances_by_recording([])
        assert grouped == {}
