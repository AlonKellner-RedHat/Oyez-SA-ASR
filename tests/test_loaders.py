# Generated by Claude
"""Tests for loaders module."""

from pathlib import Path

import pyarrow as pa
import pyarrow.parquet as pq
import pytest

from oyez_sa_asr.loaders import extract_segment, load_flex, load_raw, load_simple


class TestLoadRaw:
    """Tests for load_raw function."""

    def test_returns_dict_with_expected_keys(self, tmp_path: Path) -> None:
        """Returns dict with audio_files, transcripts, cases."""
        (tmp_path / "audio").mkdir()
        (tmp_path / "transcripts").mkdir()
        (tmp_path / "cases").mkdir()

        result = load_raw(tmp_path)

        assert "audio_files" in result
        assert "transcripts" in result
        assert "cases" in result

    def test_finds_audio_files(self, tmp_path: Path) -> None:
        """Finds MP3 and OGG files."""
        audio_dir = tmp_path / "audio"
        audio_dir.mkdir()
        (audio_dir / "test.mp3").touch()
        (audio_dir / "test.ogg").touch()
        (tmp_path / "transcripts").mkdir()
        (tmp_path / "cases").mkdir()

        result = load_raw(tmp_path)

        assert len(result["audio_files"]) == 2


class TestLoadFlex:
    """Tests for load_flex function."""

    def test_returns_empty_when_no_files(self, tmp_path: Path) -> None:
        """Returns empty lists when parquet files don't exist."""
        (tmp_path / "data").mkdir()
        recordings, utterances = load_flex(tmp_path)
        assert recordings == []
        assert utterances == []

    def test_loads_recordings_and_utterances(self, tmp_path: Path) -> None:
        """Loads data from parquet files."""
        data_dir = tmp_path / "data"
        data_dir.mkdir()

        recs = [{"term": "2024", "docket": "22-1"}]
        pq.write_table(pa.Table.from_pylist(recs), data_dir / "recordings.parquet")

        utts = [{"text": "hello", "speaker_name": "Test"}]
        pq.write_table(pa.Table.from_pylist(utts), data_dir / "utterances.parquet")

        recordings, utterances = load_flex(tmp_path)

        assert len(recordings) == 1
        assert len(utterances) == 1


class TestLoadSimple:
    """Tests for load_simple function."""

    def test_returns_empty_when_no_splits(self, tmp_path: Path) -> None:
        """Returns empty list when no splits exist."""
        result = load_simple("lt1m", tmp_path)
        assert result == []

    def test_loads_parquet_data(self, tmp_path: Path) -> None:
        """Loads data from parquet files."""
        split_dir = tmp_path / "lt1m" / "data" / "utterances"
        split_dir.mkdir(parents=True)

        data = [{"id": "1", "sentence": "hello", "speaker": "Test"}]
        pq.write_table(pa.Table.from_pylist(data), split_dir / "train-00000.parquet")

        result = load_simple("lt1m", tmp_path)

        assert len(result) == 1
        assert result[0]["sentence"] == "hello"
        assert result[0]["_split"] == "lt1m"

    def test_loads_all_splits(self, tmp_path: Path) -> None:
        """Loads from all splits when split='all'."""
        for split in ["lt1m", "lt5m"]:
            split_dir = tmp_path / split / "data" / "utterances"
            split_dir.mkdir(parents=True)
            data = [{"id": split, "sentence": f"text_{split}"}]
            pq.write_table(
                pa.Table.from_pylist(data), split_dir / "train-00000.parquet"
            )

        result = load_simple("all", tmp_path)
        assert len(result) == 2


class TestExtractSegment:
    """Tests for extract_segment function."""

    def test_raises_on_invalid_range(self, tmp_path: Path) -> None:
        """Raises ValueError when start >= end."""
        with pytest.raises(ValueError, match="must be less than"):
            extract_segment(tmp_path / "test.flac", 5.0, 3.0)
