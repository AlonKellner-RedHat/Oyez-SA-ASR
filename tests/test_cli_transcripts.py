# Generated by Claude
"""CLI tests for process transcripts command."""

import json
import re
import tempfile
from pathlib import Path

from typer.testing import CliRunner

from oyez_sa_asr.cli import app

runner = CliRunner()


def strip_ansi(text: str) -> str:
    """Remove ANSI escape codes from text."""
    return re.sub(r"\x1b\[[0-9;]*m", "", text)


class TestProcessTranscriptsCommand:
    """Tests for process transcripts CLI command."""

    def test_help(self) -> None:
        """Should show help for process transcripts."""
        result = runner.invoke(app, ["process", "transcripts", "--help"])
        assert result.exit_code == 0
        output = strip_ansi(result.output)
        assert "--cache-dir" in output
        assert "--cases-dir" in output
        assert "--output-dir" in output

    def test_empty_cache(self) -> None:
        """Should handle empty cache gracefully."""
        with tempfile.TemporaryDirectory() as tmpdir:
            cache_dir = Path(tmpdir) / "cache"
            cache_dir.mkdir()
            cases_dir = Path(tmpdir) / "cases"
            cases_dir.mkdir()
            output_dir = Path(tmpdir) / "output"

            result = runner.invoke(
                app,
                [
                    "process",
                    "transcripts",
                    "--cache-dir",
                    str(cache_dir),
                    "--cases-dir",
                    str(cases_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            assert "0" in result.output or "No" in result.output

    def test_creates_files(self) -> None:
        """Should create transcript files organized by case."""
        with tempfile.TemporaryDirectory() as tmpdir:
            # Setup cache with transcript
            cache_dir = Path(tmpdir) / "cache"
            raw_dir = cache_dir / "api.oyez.org" / "raw"
            raw_dir.mkdir(parents=True)

            transcript_data = {
                "id": 25123,
                "title": "Oral Argument - December 05, 2022",
                "media_file": [],
                "transcript": {
                    "duration": 100.0,
                    "sections": [
                        {
                            "turns": [
                                {
                                    "start": 0.0,
                                    "stop": 10.0,
                                    "speaker": {"ID": 1, "name": "A"},
                                    "text_blocks": [{"text": "Hello"}],
                                }
                            ]
                        }
                    ],
                },
            }
            (raw_dir / "abc123.json").write_text(json.dumps(transcript_data))

            # Setup cases
            cases_dir = Path(tmpdir) / "cases"
            term_dir = cases_dir / "2022"
            term_dir.mkdir(parents=True)

            case_data = {
                "docket_number": "21-476",
                "term": "2022",
                "oral_arguments": [{"id": 25123}],
                "opinion_announcements": [],
            }
            (term_dir / "21-476.json").write_text(json.dumps(case_data))

            output_dir = Path(tmpdir) / "output"

            result = runner.invoke(
                app,
                [
                    "process",
                    "transcripts",
                    "--cache-dir",
                    str(cache_dir),
                    "--cases-dir",
                    str(cases_dir),
                    "--output-dir",
                    str(output_dir),
                ],
            )

            assert result.exit_code == 0
            expected_file = output_dir / "2022" / "21-476" / "oral_argument.json"
            assert expected_file.exists()
