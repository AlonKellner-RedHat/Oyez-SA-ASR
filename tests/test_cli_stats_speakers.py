# Generated by Claude
"""Tests for stats speakers command."""

import json
import re
import tempfile
from pathlib import Path

from typer.testing import CliRunner

from oyez_sa_asr.cli import app

runner = CliRunner()


def _strip_ansi(text: str) -> str:
    """Strip ANSI escape codes from a string."""
    return re.sub(r"\x1b\[[0-9;]*m", "", text)


def _create_speaker_file(
    output_dir: Path,
    speaker_id: int,
    name: str,
    role: str = "justice",
    recordings: int = 10,
    turns: int = 100,
    duration: float = 1000.0,
    words: int = 5000,
) -> Path:
    """Create a mock speaker file."""
    name_slug = name.lower().replace(" ", "_").replace(".", "").replace(",", "")
    data = {
        "id": speaker_id,
        "name": name,
        "name_slug": name_slug,
        "role": role,
        "first_appearance": "2020-10-05",
        "last_appearance": "2024-01-15",
        "totals": {
            "recordings": recordings,
            "cases": recordings,
            "turns": turns,
            "duration_seconds": duration,
            "word_count": words,
            "avg_words_per_turn": words / turns if turns > 0 else 0,
        },
        "by_term": {
            "2024": {
                "recordings": recordings,
                "turns": turns,
                "duration_seconds": duration,
                "word_count": words,
            }
        },
        "recordings": [],
        "cases": [],
    }
    output_dir.mkdir(parents=True, exist_ok=True)
    file_path = output_dir / f"{speaker_id}_{name_slug}.json"
    file_path.write_text(json.dumps(data))
    return file_path


class TestStatsSpeakersHelp:
    """Tests for help output."""

    def test_help(self) -> None:
        """Shows help message."""
        result = runner.invoke(app, ["stats", "speakers", "--help"])
        assert result.exit_code == 0
        assert "speakers" in result.output.lower()


class TestStatsSpeakersMissingData:
    """Tests for missing data handling."""

    def test_missing_speakers_dir(self) -> None:
        """Fails gracefully when speakers directory doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = runner.invoke(
                app,
                ["stats", "speakers", "--data-dir", str(Path(tmpdir) / "missing")],
            )
            output = _strip_ansi(result.output)
            assert result.exit_code == 1
            assert "not found" in output.lower()

    def test_no_speakers_found(self) -> None:
        """Shows message when no speakers found."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            (data_dir / "speakers").mkdir()

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)
            assert result.exit_code == 0
            assert "no speakers found" in output.lower()


class TestStatsSpeakersDisplay:
    """Tests for statistics display."""

    def test_displays_basic_stats(self) -> None:
        """Displays basic speaker statistics."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            _create_speaker_file(
                speakers_dir,
                speaker_id=123,
                name="Justice Smith",
                role="justice",
                recordings=10,
                turns=100,
                duration=1000.0,
                words=5000,
            )
            _create_speaker_file(
                speakers_dir,
                speaker_id=456,
                name="Mr. Jones",
                role="advocate",
                recordings=5,
                turns=50,
                duration=500.0,
                words=2500,
            )

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Speaker Statistics" in output
            assert "Total speakers: 2" in output
            assert "justice" in output.lower()
            assert "advocate" in output.lower()

    def test_displays_top_speakers(self) -> None:
        """Displays top speakers by turn count."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            _create_speaker_file(
                speakers_dir,
                speaker_id=123,
                name="Justice Smith",
                turns=500,
            )
            _create_speaker_file(
                speakers_dir,
                speaker_id=456,
                name="Justice Jones",
                turns=300,
            )
            _create_speaker_file(
                speakers_dir,
                speaker_id=789,
                name="Mr. Advocate",
                role="advocate",
                turns=100,
            )

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir), "--top", "2"]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Justice Smith" in output
            assert "Justice Jones" in output

    def test_term_filter(self) -> None:
        """Filters speakers by term."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            # Create speaker with data in multiple terms
            speaker_data = {
                "id": 123,
                "name": "Justice Smith",
                "name_slug": "justice_smith",
                "role": "justice",
                "first_appearance": "2023-10-05",
                "last_appearance": "2024-01-15",
                "totals": {
                    "recordings": 20,
                    "cases": 20,
                    "turns": 200,
                    "duration_seconds": 2000.0,
                    "word_count": 10000,
                    "avg_words_per_turn": 50.0,
                },
                "by_term": {
                    "2023": {
                        "recordings": 10,
                        "turns": 100,
                        "duration_seconds": 1000.0,
                        "word_count": 5000,
                    },
                    "2024": {
                        "recordings": 10,
                        "turns": 100,
                        "duration_seconds": 1000.0,
                        "word_count": 5000,
                    },
                },
                "recordings": [],
                "cases": ["2023/docket1", "2024/docket2"],
            }
            speakers_dir.mkdir(parents=True)
            (speakers_dir / "123_justice_smith.json").write_text(
                json.dumps(speaker_data)
            )

            result = runner.invoke(
                app,
                ["stats", "speakers", "--data-dir", str(data_dir), "--term", "2024"],
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            # Stats should only reflect 2024 term
            assert "100" in output  # turns from 2024 only
