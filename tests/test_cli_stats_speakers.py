# Generated by Claude
"""Tests for stats speakers command."""

import json
import re
import tempfile
from pathlib import Path

from typer.testing import CliRunner

from oyez_sa_asr.cli import app

runner = CliRunner()


def _strip_ansi(text: str) -> str:
    """Strip ANSI escape codes from a string."""
    return re.sub(r"\x1b\[[0-9;]*m", "", text)


def _create_speaker_file(
    output_dir: Path,
    speaker_id: int,
    name: str,
    role: str = "other",
    recordings: int = 10,
    turns: int = 100,
    duration: float = 1000.0,
    words: int = 5000,
) -> Path:
    """Create a mock speaker file in role-based subdirectory."""
    name_slug = name.lower().replace(" ", "_").replace(".", "").replace(",", "")
    data = {
        "id": speaker_id,
        "name": name,
        "name_slug": name_slug,
        "role": role,
        "first_appearance": "2020-10-05",
        "last_appearance": "2024-01-15",
        "totals": {
            "recordings": recordings,
            "cases": recordings,
            "turns": turns,
            "duration_seconds": duration,
            "word_count": words,
            "avg_words_per_turn": words / turns if turns > 0 else 0,
        },
        "by_term": {
            "2024": {
                "recordings": recordings,
                "turns": turns,
                "duration_seconds": duration,
                "word_count": words,
            }
        },
        "recordings": [],
        "cases": [],
    }
    subdir = "justices" if role == "justice" else "other"
    target_dir = output_dir / subdir
    target_dir.mkdir(parents=True, exist_ok=True)
    file_path = target_dir / f"{speaker_id}_{name_slug}.json"
    file_path.write_text(json.dumps(data))
    return file_path


class TestStatsSpeakersHelp:
    """Tests for help output."""

    def test_help(self) -> None:
        """Show help message."""
        result = runner.invoke(app, ["stats", "speakers", "--help"])
        assert result.exit_code == 0
        assert "speakers" in result.output.lower()


class TestStatsSpeakersMissingData:
    """Tests for missing data handling."""

    def test_missing_speakers_dir(self) -> None:
        """Fail gracefully when speakers directory doesn't exist."""
        with tempfile.TemporaryDirectory() as tmpdir:
            result = runner.invoke(
                app,
                ["stats", "speakers", "--data-dir", str(Path(tmpdir) / "missing")],
            )
            output = _strip_ansi(result.output)
            assert result.exit_code == 1
            assert "not found" in output.lower()

    def test_no_speakers_found(self) -> None:
        """Show message when no speakers found."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            (data_dir / "speakers").mkdir()

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)
            assert result.exit_code == 0
            assert "no speakers found" in output.lower()


class TestStatsSpeakersDisplay:
    """Tests for statistics display."""

    def test_displays_basic_stats(self) -> None:
        """Display basic speaker statistics."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            _create_speaker_file(
                speakers_dir, 123, "Justice Smith", "justice", 10, 100, 1000.0, 5000
            )
            _create_speaker_file(
                speakers_dir, 456, "Mr. Jones", "advocate", 5, 50, 500.0, 2500
            )

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir)]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Speaker Statistics" in output
            assert "Total speakers: 2" in output
            assert "justice" in output.lower()
            assert "advocate" in output.lower()

    def test_displays_top_speakers(self) -> None:
        """Display top speakers by turn count."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers"

            _create_speaker_file(speakers_dir, 123, "Justice Smith", turns=500)
            _create_speaker_file(speakers_dir, 456, "Justice Jones", turns=300)
            _create_speaker_file(
                speakers_dir, 789, "Mr. Advocate", "advocate", turns=100
            )

            result = runner.invoke(
                app, ["stats", "speakers", "--data-dir", str(data_dir), "--top", "2"]
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "Justice Smith" in output
            assert "Justice Jones" in output

    def test_term_filter(self) -> None:
        """Filter speakers by term."""
        with tempfile.TemporaryDirectory() as tmpdir:
            data_dir = Path(tmpdir)
            speakers_dir = data_dir / "speakers" / "other"
            speakers_dir.mkdir(parents=True)

            speaker_data = {
                "id": 123,
                "name": "Test Speaker",
                "name_slug": "test_speaker",
                "role": "other",
                "totals": {"recordings": 20, "turns": 200, "duration_seconds": 2000.0},
                "by_term": {
                    "2023": {
                        "recordings": 10,
                        "turns": 100,
                        "duration_seconds": 1000.0,
                    },
                    "2024": {
                        "recordings": 10,
                        "turns": 100,
                        "duration_seconds": 1000.0,
                    },
                },
                "recordings": [],
            }
            (speakers_dir / "123_test_speaker.json").write_text(
                json.dumps(speaker_data)
            )

            result = runner.invoke(
                app,
                ["stats", "speakers", "--data-dir", str(data_dir), "--term", "2024"],
            )
            output = _strip_ansi(result.output)

            assert result.exit_code == 0
            assert "100" in output
