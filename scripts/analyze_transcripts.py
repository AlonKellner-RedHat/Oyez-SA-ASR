#!/usr/bin/env python3
# Generated by Claude
# ruff: noqa: PLR0912, PLR0915
"""Analyze raw transcript structure from cached API responses."""

import json
from collections import Counter, defaultdict
from pathlib import Path
from typing import Any


def analyze_transcripts(cache_dir: Path) -> dict[str, Any]:
    """Analyze all cached transcripts and gather statistics."""
    raw_dir = cache_dir / "api.oyez.org" / "raw"

    stats = {
        "total_files": 0,
        "with_transcript": 0,
        "without_transcript": 0,
        "damaged": 0,
        "unavailable": 0,
        "with_media_files": 0,
        "total_sections": 0,
        "total_turns": 0,
        "total_text_blocks": 0,
        "total_duration_seconds": 0.0,
        "speakers": Counter(),
        "section_counts": Counter(),
        "media_formats": Counter(),
        "null_speakers": 0,
        "empty_text_blocks": 0,
        "max_sections": 0,
        "max_turns_per_section": 0,
        "max_text_blocks_per_turn": 0,
        "titles_by_type": defaultdict(int),
        "missing_fields": defaultdict(int),
    }

    for json_file in raw_dir.glob("*.json"):
        stats["total_files"] += 1

        try:
            with json_file.open() as f:
                data = json.load(f)
        except json.JSONDecodeError:
            stats["missing_fields"]["json_decode_error"] += 1
            continue

        # Check top-level flags
        if data.get("damaged"):
            stats["damaged"] += 1
        if data.get("unavailable"):
            stats["unavailable"] += 1

        # Analyze media files
        media_files = data.get("media_file") or []
        if media_files:
            stats["with_media_files"] += 1
            for mf in media_files:
                if mf is None:
                    continue
                mime = mf.get("mime", "unknown")
                stats["media_formats"][mime] += 1

        # Categorize by title pattern
        title = data.get("title", "")
        if "Oral Argument" in title:
            stats["titles_by_type"]["oral_argument"] += 1
        elif "Opinion Announcement" in title:
            stats["titles_by_type"]["opinion_announcement"] += 1
        elif "Dissenting Opinion" in title:
            stats["titles_by_type"]["dissent"] += 1
        elif "Concurring Opinion" in title:
            stats["titles_by_type"]["concurrence"] += 1
        else:
            stats["titles_by_type"]["other"] += 1

        # Analyze transcript
        transcript = data.get("transcript")
        if not transcript:
            stats["without_transcript"] += 1
            continue

        stats["with_transcript"] += 1
        stats["total_duration_seconds"] += transcript.get("duration", 0) or 0

        sections = transcript.get("sections") or []
        stats["total_sections"] += len(sections)
        stats["section_counts"][len(sections)] += 1
        stats["max_sections"] = max(stats["max_sections"], len(sections))

        for section in sections:
            turns = section.get("turns") or []
            stats["total_turns"] += len(turns)
            stats["max_turns_per_section"] = max(
                stats["max_turns_per_section"], len(turns)
            )

            for turn in turns:
                speaker = turn.get("speaker")
                if speaker is None:
                    stats["null_speakers"] += 1
                else:
                    speaker_name = speaker.get("name", "Unknown")
                    stats["speakers"][speaker_name] += 1

                text_blocks = turn.get("text_blocks") or []
                stats["total_text_blocks"] += len(text_blocks)
                stats["max_text_blocks_per_turn"] = max(
                    stats["max_text_blocks_per_turn"], len(text_blocks)
                )

                for block in text_blocks:
                    text = block.get("text", "")
                    if not text or not text.strip():
                        stats["empty_text_blocks"] += 1

    return stats


def format_duration(seconds: float) -> str:
    """Format duration as hours:minutes:seconds."""
    hours = int(seconds // 3600)
    minutes = int((seconds % 3600) // 60)
    secs = int(seconds % 60)
    return f"{hours}h {minutes}m {secs}s"


def main() -> None:
    """Run transcript analysis and print report."""
    cache_dir = Path(".cache/transcripts")
    print("Analyzing transcripts...\n")

    stats = analyze_transcripts(cache_dir)

    print("=" * 60)
    print("TRANSCRIPT ANALYSIS REPORT")
    print("=" * 60)

    print("\n## File Statistics")
    print(f"  Total files: {stats['total_files']:,}")
    print(f"  With transcript: {stats['with_transcript']:,}")
    print(f"  Without transcript: {stats['without_transcript']:,}")
    print(f"  Damaged: {stats['damaged']:,}")
    print(f"  Unavailable: {stats['unavailable']:,}")
    print(f"  With media files: {stats['with_media_files']:,}")

    print("\n## Content by Type")
    for type_name, count in sorted(
        stats["titles_by_type"].items(), key=lambda x: -x[1]
    ):
        print(f"  {type_name}: {count:,}")

    print("\n## Audio Duration")
    print(f"  Total: {format_duration(stats['total_duration_seconds'])}")
    print(f"  ({stats['total_duration_seconds']:,.0f} seconds)")
    if stats["with_transcript"] > 0:
        avg = stats["total_duration_seconds"] / stats["with_transcript"]
        print(f"  Average per transcript: {format_duration(avg)}")

    print("\n## Transcript Structure")
    print(f"  Total sections: {stats['total_sections']:,}")
    print(f"  Total turns: {stats['total_turns']:,}")
    print(f"  Total text blocks: {stats['total_text_blocks']:,}")
    print(f"  Max sections per transcript: {stats['max_sections']}")
    print(f"  Max turns per section: {stats['max_turns_per_section']}")
    print(f"  Max text blocks per turn: {stats['max_text_blocks_per_turn']}")

    print("\n## Section Count Distribution")
    for count, freq in sorted(stats["section_counts"].items()):
        print(f"  {count} section(s): {freq:,} transcripts")

    print("\n## Media Formats")
    for fmt, count in stats["media_formats"].most_common(10):
        print(f"  {fmt}: {count:,}")

    print("\n## Data Quality")
    print(f"  Null speakers (turns without speaker): {stats['null_speakers']:,}")
    print(f"  Empty text blocks: {stats['empty_text_blocks']:,}")

    print("\n## Top 20 Speakers")
    for speaker, count in stats["speakers"].most_common(20):
        print(f"  {speaker}: {count:,} turns")

    print("\n## Speaker Statistics")
    print(f"  Unique speakers: {len(stats['speakers']):,}")


if __name__ == "__main__":
    main()
