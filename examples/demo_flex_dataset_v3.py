#!/usr/bin/env python3
# Generated by Claude
"""Demo: Loading oyez-sa-asr-flex dataset with HuggingFace datasets v3.x.

This demo uses trust_remote_code=True to load via the custom loading script,
which provides automatic audio decoding and on-the-fly segment extraction
for utterances.

Requires: datasets>=3.0,<4.0

Usage:
    python examples/demo_flex_dataset_v3.py
    python examples/demo_flex_dataset_v3.py --config utterances
"""

import argparse
from pathlib import Path


def check_version() -> bool:
    """Check if we're running datasets v3.x."""
    try:
        from oyez_sa_asr.hf_compat import (  # noqa: PLC0415
            is_v4,
            supports_loading_scripts,
        )

        if is_v4():
            print(
                "WARNING: You're running datasets v4.x which doesn't support loading scripts."
            )
            print(
                "This demo requires datasets v3.x. Use demo_flex_dataset.py for v4.x instead."
            )
            return False
        print(f"datasets supports loading scripts: {supports_loading_scripts()}")
        return True
    except ImportError:
        print("Note: oyez_sa_asr not installed, skipping version check")
        return True


def demo_recordings(dataset_dir: Path, limit: int) -> None:
    """Demo the recordings config with decoded audio."""
    from datasets import load_dataset  # noqa: PLC0415

    print("\nLoading 'recordings' config...")
    print("Audio will be automatically decoded from FLAC files.")

    ds = load_dataset(
        "src/oyez_sa_asr/hf_scripts/flex.py",
        "recordings",
        data_dir=str(dataset_dir),
        trust_remote_code=True,
        streaming=True,
    )

    print(f"\n{'=' * 60}")
    print(f"Sample Recordings (first {limit})")
    print("=" * 60)

    for i, sample in enumerate(ds["train"]):
        if i >= limit:
            break
        print(f"\n[{i + 1}] {sample.get('term', '?')}/{sample.get('docket', '?')}")
        print(f"    Recording ID: {sample.get('recording_id', 'N/A')}")
        print(f"    Duration: {sample.get('duration_sec', 0):.1f}s")
        print(f"    Format: {sample.get('source_format', 'N/A')}")

        audio = sample.get("audio")
        if audio:
            actual_dur = len(audio["array"]) / audio["sampling_rate"]
            print(
                f"    Audio: {actual_dur:.1f}s @ {audio['sampling_rate']} Hz (decoded)"
            )


def demo_utterances(dataset_dir: Path, limit: int) -> None:
    """Demo the utterances config with on-the-fly segment extraction."""
    from datasets import load_dataset  # noqa: PLC0415

    print("\nLoading 'utterances' config...")
    print("Audio segments will be extracted on-the-fly from FLAC files.")

    ds = load_dataset(
        "src/oyez_sa_asr/hf_scripts/flex.py",
        "utterances",
        data_dir=str(dataset_dir),
        trust_remote_code=True,
        streaming=True,
    )

    print(f"\n{'=' * 60}")
    print(f"Sample Utterances (first {limit})")
    print("=" * 60)

    for i, sample in enumerate(ds["train"]):
        if i >= limit:
            break
        print(f"\n[{i + 1}] {sample.get('term', '?')}/{sample.get('docket', '?')}")
        print(f"    Speaker: {sample.get('speaker_name', 'Unknown')}")
        print(
            f"    Time: {sample.get('start_sec', 0):.1f}s - {sample.get('end_sec', 0):.1f}s"
        )
        text = sample.get("text", "")[:60]
        print(f"    Text: {text}...")

        audio = sample.get("audio")
        if audio:
            actual_dur = len(audio["array"]) / audio["sampling_rate"]
            print(f"    Audio segment: {actual_dur:.1f}s (extracted on-the-fly)")


def main() -> None:
    """Demo the flex dataset with v3.x trust_remote_code loading."""
    parser = argparse.ArgumentParser(description="Demo the flex dataset (v3.x)")
    parser.add_argument("--dataset-dir", type=Path, default=Path("datasets/flex"))
    parser.add_argument(
        "--config", default="recordings", choices=["recordings", "utterances"]
    )
    parser.add_argument("--limit", type=int, default=3)
    args = parser.parse_args()

    print("=" * 60)
    print("Oyez SA-ASR Flex Dataset Demo (v3.x)")
    print("=" * 60)

    if not check_version():
        return

    if not args.dataset_dir.exists():
        print(f"\nError: Dataset not found at {args.dataset_dir}")
        print("Run the pipeline first: oyez pipeline run --term 2024")
        return

    try:
        from datasets import load_dataset  # noqa: F401, PLC0415
    except ImportError:
        print("Error: 'datasets' package required. Install with: uv add datasets")
        return

    print(f"\nDataset directory: {args.dataset_dir}")
    print(f"Config: {args.config}")

    if args.config == "recordings":
        demo_recordings(args.dataset_dir, args.limit)
    else:
        demo_utterances(args.dataset_dir, args.limit)

    print("\n" + "=" * 60)
    print("v3.x Advantages:")
    print("  - Automatic audio decoding from FLAC files")
    print("  - On-the-fly segment extraction for utterances")
    print("  - No manual extract_segment() calls needed")
    print("=" * 60)


if __name__ == "__main__":
    main()
