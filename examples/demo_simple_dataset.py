#!/usr/bin/env python3
# Generated by Claude
"""Demo: Loading and using the oyez-sa-asr-simple dataset.

This dataset has audio embedded directly in parquet files, making it
ideal for streaming and quick experimentation without managing files.

Usage:
    python examples/demo_simple_dataset.py
    python examples/demo_simple_dataset.py --dataset-dir datasets/simple
"""

import argparse
from pathlib import Path

try:
    import pyarrow.parquet as pq

    HAS_PYARROW = True
except ImportError:
    HAS_PYARROW = False
    pq = None  # type: ignore[assignment]


def load_simple_dataset(dataset_dir: Path) -> list[dict]:
    """Load utterances from the simple dataset."""
    if not HAS_PYARROW or pq is None:
        print("Error: pyarrow is required. Install with: uv add pyarrow")
        return []
    utterances = []
    for shard_file in sorted(dataset_dir.glob("train-*.parquet")):
        table = pq.read_table(shard_file)
        utterances.extend(table.to_pylist())
    return utterances


def print_samples(utterances: list[dict], limit: int) -> None:
    """Print sample utterances."""
    print(f"\n{'=' * 60}")
    print(f"Sample Utterances (first {limit})")
    print("=" * 60)
    for i, utt in enumerate(utterances[:limit]):
        print(f"\n[{i + 1}] {utt.get('term', '?')}/{utt.get('docket', '?')}")
        print(f"    Speaker: {utt.get('speaker_name', 'Unknown')}")
        print(f"    Duration: {utt.get('duration_sec', 0):.2f}s")
        text = utt.get("text", "")[:80]
        print(f"    Text: {text}...")
        audio = utt.get("audio_bytes")
        if audio:
            print(f"    Audio: {len(audio):,} bytes")


def main() -> None:
    """Demo the simple dataset with embedded audio."""
    parser = argparse.ArgumentParser(description="Demo the simple dataset")
    parser.add_argument("--dataset-dir", type=Path, default=Path("datasets/simple"))
    parser.add_argument("--limit", type=int, default=5)
    args = parser.parse_args()

    print("=" * 60)
    print("Oyez SA-ASR Simple Dataset Demo")
    print("=" * 60)
    print(f"\nDataset directory: {args.dataset_dir}")

    if not args.dataset_dir.exists():
        print(f"\nError: Dataset not found at {args.dataset_dir}")
        print("Run the pipeline first: oyez pipeline run --term 2024")
        return

    utterances = load_simple_dataset(args.dataset_dir)
    print(f"Loaded {len(utterances):,} utterances")

    if utterances:
        print_samples(utterances, args.limit)
        total_dur = sum(u.get("duration_sec", 0) or 0 for u in utterances)
        print(f"\nTotal duration: {total_dur / 3600:.1f} hours")

    print("\n" + "=" * 60)
    print("Demo complete!")


if __name__ == "__main__":
    main()
