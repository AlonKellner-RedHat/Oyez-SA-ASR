#!/usr/bin/env python3
# Generated by Claude
"""Demo: Loading and using the oyez-sa-asr-flex dataset (v4.x compatible).

This demo loads metadata directly from parquet files using pyarrow.
Compatible with HuggingFace datasets v4.x (parquet auto-discovery).

For v3.x with trust_remote_code=True and automatic audio decoding/segment
extraction, see demo_flex_dataset_v3.py instead.

This dataset separates audio (FLAC files) from metadata (parquet).
It's ideal for custom audio processing pipelines.

Usage:
    python examples/demo_flex_dataset.py
    python examples/demo_flex_dataset.py --dataset-dir datasets/flex
"""

import argparse
from pathlib import Path

try:
    import pyarrow.parquet as pq

    HAS_PYARROW = True
except ImportError:
    HAS_PYARROW = False
    pq = None  # type: ignore[assignment]


def load_parquet(file_path: Path) -> list[dict]:
    """Load records from a parquet file."""
    if not HAS_PYARROW or pq is None:
        print("Error: pyarrow is required. Install with: uv add pyarrow")
        return []
    if not file_path.exists():
        return []
    table = pq.read_table(file_path)
    return table.to_pylist()


def print_recordings(recordings: list[dict], limit: int) -> None:
    """Print sample recordings."""
    print(f"\n{'=' * 60}")
    print(f"Sample Recordings (first {limit})")
    print("=" * 60)
    for i, rec in enumerate(recordings[:limit]):
        print(f"\n[{i + 1}] {rec.get('term', '?')}/{rec.get('docket', '?')}")
        print(f"    Audio: {rec.get('audio_path', 'N/A')}")
        print(f"    Duration: {rec.get('duration_sec', 0):.1f}s")
        print(f"    Format: {rec.get('source_format', 'unknown')}")


def print_audio_stats(dataset_dir: Path) -> None:
    """Print audio file statistics."""
    audio_dir = dataset_dir / "audio"
    if not audio_dir.exists():
        return
    flac_files = list(audio_dir.rglob("*.flac"))
    print(f"\n{'=' * 60}")
    print("Audio Files")
    print("=" * 60)
    print(f"  FLAC files: {len(flac_files):,}")
    if flac_files:
        total_size = sum(f.stat().st_size for f in flac_files)
        print(f"  Total size: {total_size / (1024**3):.2f} GB")


def main() -> None:
    """Demo the flex dataset."""
    parser = argparse.ArgumentParser(description="Demo the flex dataset")
    parser.add_argument("--dataset-dir", type=Path, default=Path("datasets/flex"))
    parser.add_argument("--limit", type=int, default=5)
    args = parser.parse_args()

    print("=" * 60)
    print("Oyez SA-ASR Flex Dataset Demo")
    print("=" * 60)
    print(f"\nDataset directory: {args.dataset_dir}")

    if not args.dataset_dir.exists():
        print(f"\nError: Dataset not found at {args.dataset_dir}")
        print("Run the pipeline first: oyez pipeline run --term 2024")
        return

    recordings = load_parquet(args.dataset_dir / "data" / "recordings.parquet")
    utterances = load_parquet(args.dataset_dir / "data" / "utterances.parquet")
    print(f"Recordings: {len(recordings):,}, Utterances: {len(utterances):,}")

    if recordings:
        print_recordings(recordings, args.limit)
    print_audio_stats(args.dataset_dir)

    print("\n" + "=" * 60)
    print("Demo complete!")


if __name__ == "__main__":
    main()
