#!/usr/bin/env python3
# Generated by Claude
"""Demo: Loading and using the oyez-sa-asr-raw dataset (v4.x compatible).

This demo explores the raw dataset structure by counting files.
Compatible with HuggingFace datasets v4.x (parquet auto-discovery).

For v3.x with trust_remote_code=True and automatic audio decoding,
see demo_raw_dataset_v3.py instead.

This dataset contains the original cached files (MP3/OGG audio, JSON metadata).
It's ideal for custom processing or archival purposes.

Usage:
    python examples/demo_raw_dataset.py
    python examples/demo_raw_dataset.py --dataset-dir datasets/raw
"""

import argparse
from pathlib import Path


def count_files(directory: Path, pattern: str) -> tuple[int, int]:
    """Count files matching pattern and their total size."""
    files = list(directory.rglob(pattern))
    total_size = sum(f.stat().st_size for f in files) if files else 0
    return len(files), total_size


def format_size(size_bytes: int) -> str:
    """Format bytes as human-readable size."""
    size = float(size_bytes)
    for unit in ("B", "KB", "MB", "GB"):
        if abs(size) < 1024:
            return f"{size:.1f} {unit}"
        size /= 1024
    return f"{size:.1f} TB"


def print_audio_stats(audio_dir: Path) -> None:
    """Print audio file statistics."""
    if not audio_dir.exists():
        print("  No audio directory found")
        return
    mp3_count, mp3_size = count_files(audio_dir, "*.mp3")
    ogg_count, ogg_size = count_files(audio_dir, "*.ogg")
    print(f"  MP3: {mp3_count:,} ({format_size(mp3_size)})")
    print(f"  OGG: {ogg_count:,} ({format_size(ogg_size)})")


def print_json_stats(json_dir: Path, name: str) -> None:
    """Print JSON file statistics."""
    if not json_dir.exists():
        print(f"  No {name} directory found")
        return
    count, size = count_files(json_dir, "*.json")
    print(f"  {name}: {count:,} files ({format_size(size)})")


def main() -> None:
    """Demo the raw dataset with original cached files."""
    parser = argparse.ArgumentParser(description="Demo the raw dataset")
    parser.add_argument("--dataset-dir", type=Path, default=Path("datasets/raw"))
    args = parser.parse_args()

    print("=" * 60)
    print("Oyez SA-ASR Raw Dataset Demo")
    print("=" * 60)
    print(f"\nDataset directory: {args.dataset_dir}")

    if not args.dataset_dir.exists():
        print(f"\nError: Dataset not found at {args.dataset_dir}")
        print("Run the pipeline first: oyez pipeline run --term 2024")
        return

    print(f"\n{'=' * 60}")
    print("Contents")
    print("=" * 60)
    print_audio_stats(args.dataset_dir / "audio")
    print_json_stats(args.dataset_dir / "cases", "Cases")
    print_json_stats(args.dataset_dir / "transcripts", "Transcripts")

    print("\n" + "=" * 60)
    print("Demo complete!")


if __name__ == "__main__":
    main()
