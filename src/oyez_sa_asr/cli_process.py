# Generated by Claude
"""Process subcommands for oyez_sa_asr CLI."""

import json
from pathlib import Path
from typing import Annotated

import typer
from rich.console import Console
from tqdm import tqdm

from .scraper import parse_cached_cases
from .scraper.parser_cases import ProcessedCase

process_app = typer.Typer(help="Process cached data into structured files")
console = Console(force_terminal=True)


@process_app.command(name="index")
def process_index(
    cache_dir: Annotated[
        Path,
        typer.Option("--cache-dir", "-c", help="Directory with cached responses"),
    ] = Path(".cache/index"),
    output: Annotated[
        Path,
        typer.Option("--output", "-o", help="Output JSON file path"),
    ] = Path("data/index/cases_index.json"),
) -> None:
    """Parse cached case index into a structured JSON file."""
    console.print("[bold]Parsing cached case index[/bold]")
    console.print(f"  Cache dir: {cache_dir}")
    console.print(f"  Output: {output}")
    console.print()

    index = parse_cached_cases(cache_dir)

    if index.total_cases == 0:
        console.print("[yellow]Warning:[/yellow] No cached cases found.")
        console.print("Run 'scrape index' first to fetch cases from the API.")
        return

    index.save(output)

    console.print(f"[bold green]Done![/bold green] Parsed {index.total_cases} cases.")
    console.print(f"Index saved to: {output}")


@process_app.command(name="cases")
def process_cases(
    cache_dir: Annotated[
        Path,
        typer.Option("--cache-dir", "-c", help="Directory with cached case responses"),
    ] = Path(".cache/cases"),
    output_dir: Annotated[
        Path,
        typer.Option("--output-dir", "-o", help="Output directory for processed cases"),
    ] = Path("data/cases"),
) -> None:
    """Parse cached case details into structured JSON files.

    Creates one JSON file per case at data/cases/{term}/{docket}.json
    with audio references ready for scrape transcripts/audio commands.
    """
    console.print("[bold]Processing cached case details[/bold]")
    console.print(f"  Cache dir: {cache_dir}")
    console.print(f"  Output dir: {output_dir}")
    console.print()

    raw_dir = cache_dir / "api.oyez.org" / "raw"

    if not raw_dir.exists():
        console.print("[yellow]Warning:[/yellow] No cached cases found.")
        console.print("Run 'scrape cases' first to fetch case details from the API.")
        return

    # Process all cached case files
    processed_count = 0
    error_count = 0

    raw_files = list(raw_dir.glob("*.json"))
    if not raw_files:
        console.print("[yellow]Warning:[/yellow] No cached cases found.")
        console.print("Run 'scrape cases' first to fetch case details from the API.")
        return

    with tqdm(raw_files, desc="Processing", unit="case") as pbar:
        for raw_file in pbar:
            try:
                with raw_file.open() as f:
                    raw_data = json.load(f)

                # Skip non-case responses (e.g., lists)
                if isinstance(raw_data, list):
                    continue
                if "ID" not in raw_data:
                    continue

                case = ProcessedCase.from_raw(raw_data)
                case.save(output_dir)
                processed_count += 1

            except (json.JSONDecodeError, KeyError, TypeError):
                error_count += 1
                pbar.set_postfix(errors=error_count)

    console.print()
    console.print(f"[bold green]Done![/bold green] Processed {processed_count} cases.")
    if error_count > 0:
        console.print(
            f"[yellow]Warnings:[/yellow] {error_count} files skipped due to errors"
        )
    console.print(f"Output: {output_dir}")
