# Generated by Claude
"""Parser for cached Oyez case list responses."""

import json
from dataclasses import dataclass, field
from datetime import datetime, timezone
from pathlib import Path
from typing import Any


def unix_timestamp_to_iso(timestamp: int | None) -> str | None:
    """Convert Unix timestamp to ISO date string.

    Args:
        timestamp: Unix timestamp (seconds since epoch), can be negative.

    Returns
    -------
        ISO date string (YYYY-MM-DD) or None if timestamp is None.
    """
    if timestamp is None:
        return None
    dt = datetime.fromtimestamp(timestamp, tz=timezone.utc)
    return dt.strftime("%Y-%m-%d")


@dataclass
class TimelineEvent:
    """A timeline event for a case (e.g., Argued, Decided)."""

    event: str
    date: str | None

    @classmethod
    def from_raw(cls, raw: dict[str, Any]) -> "TimelineEvent":
        """Parse from raw API response."""
        dates = raw.get("dates", [])
        date = unix_timestamp_to_iso(dates[0]) if dates else None
        return cls(event=raw.get("event", ""), date=date)

    def to_dict(self) -> dict[str, Any]:
        """Convert to dictionary for JSON serialization."""
        return {"event": self.event, "date": self.date}


@dataclass
class Citation:
    """Citation information for a case."""

    volume: str
    page: str
    year: str

    @classmethod
    def from_raw(cls, raw: dict[str, Any] | None) -> "Citation | None":
        """Parse from raw API response."""
        if raw is None:
            return None
        return cls(
            volume=raw.get("volume", ""),
            page=raw.get("page", ""),
            year=raw.get("year", ""),
        )

    def to_dict(self) -> dict[str, str]:
        """Convert to dictionary for JSON serialization."""
        return {"volume": self.volume, "page": self.page, "year": self.year}


@dataclass
class CaseSummary:
    """Summary of a case from the cases list API."""

    id: int
    name: str
    href: str
    docket_number: str
    term: str
    citation: Citation | None
    timeline: list[TimelineEvent]
    question: str | None
    description: str | None
    justia_url: str | None

    @classmethod
    def from_raw(cls, raw: dict[str, Any]) -> "CaseSummary":
        """Parse from raw API response."""
        timeline_raw = raw.get("timeline", []) or []
        # Filter out None entries in timeline
        timeline = [TimelineEvent.from_raw(t) for t in timeline_raw if t is not None]

        return cls(
            id=raw.get("ID", 0),
            name=raw.get("name", ""),
            href=raw.get("href", ""),
            docket_number=raw.get("docket_number", ""),
            term=raw.get("term", ""),
            citation=Citation.from_raw(raw.get("citation")),
            timeline=timeline,
            question=raw.get("question"),
            description=raw.get("description"),
            justia_url=raw.get("justia_url"),
        )

    def to_dict(self) -> dict[str, Any]:
        """Convert to dictionary for JSON serialization."""
        return {
            "id": self.id,
            "name": self.name,
            "href": self.href,
            "docket_number": self.docket_number,
            "term": self.term,
            "citation": self.citation.to_dict() if self.citation else None,
            "timeline": [t.to_dict() for t in self.timeline],
            "question": self.question,
            "description": self.description,
            "justia_url": self.justia_url,
        }


@dataclass
class CasesIndex:
    """Index of all parsed cases with metadata."""

    cases: list[CaseSummary]
    generated_at: datetime = field(default_factory=lambda: datetime.now(timezone.utc))

    @property
    def total_cases(self) -> int:
        """Get total number of cases."""
        return len(self.cases)

    def to_dict(self) -> dict[str, Any]:
        """Convert to dictionary for JSON serialization."""
        return {
            "generated_at": self.generated_at.isoformat(),
            "total_cases": self.total_cases,
            "cases": [c.to_dict() for c in self.cases],
        }

    def save(self, path: Path) -> None:
        """Save index to a JSON file.

        Args:
            path: Output file path.
        """
        path.parent.mkdir(parents=True, exist_ok=True)
        with path.open("w") as f:
            json.dump(self.to_dict(), f, indent=2)


def parse_cached_cases(cache_dir: Path) -> CasesIndex:
    """Parse all cached case list responses into a CasesIndex.

    Args:
        cache_dir: Root cache directory.

    Returns
    -------
        CasesIndex with all parsed cases.
    """
    raw_dir = cache_dir / "api.oyez.org" / "raw"

    if not raw_dir.exists():
        return CasesIndex(cases=[])

    all_cases: list[CaseSummary] = []

    for raw_file in sorted(raw_dir.glob("*.json")):
        try:
            with raw_file.open() as f:
                data = json.load(f)

            # Skip if not a list (might be a different response type)
            if not isinstance(data, list):
                continue

            # Skip empty responses
            if len(data) == 0:
                continue

            # Parse each case in the response
            for case_raw in data:
                case = CaseSummary.from_raw(case_raw)
                all_cases.append(case)

        except (json.JSONDecodeError, KeyError, TypeError):
            # Skip corrupted files
            continue

    return CasesIndex(cases=all_cases)
