# Generated by Claude
"""Pipeline command for running the full scrape-to-dataset workflow."""

import subprocess
import sys
from typing import Annotated

import typer
from rich.console import Console

pipeline_app = typer.Typer(
    help="Run the full pipeline from scraping to dataset creation"
)
console = Console(force_terminal=True)

# Define pipeline steps for each phase
SCRAPE_STEPS = [
    ("Scrape Index", ["scrape", "index"], False),
    ("Process Index", ["process", "index"], False),
    ("Scrape Cases", ["scrape", "cases"], True),
    ("Scrape Transcripts", ["scrape", "transcripts"], True),
    ("Scrape Audio", ["scrape", "audio"], True),
]

PROCESS_STEPS = [
    ("Process Cases", ["process", "cases"], True),
    ("Process Transcripts", ["process", "transcripts"], True),
    ("Process Audio", ["process", "audio"], True),
    ("Process Speakers", ["process", "speakers"], True),
]

DATASET_STEPS = [
    ("Dataset Raw", ["dataset", "raw"], True),
    ("Dataset Flex", ["dataset", "flex"], True),
    ("Dataset Simple", ["dataset", "simple"], False),
]


def _run_step(step_name: str, cmd: list[str]) -> bool:
    """Run a pipeline step and return success status."""
    console.print(f"\n[bold blue]{'=' * 60}[/bold blue]")
    console.print(f"[bold]Step: {step_name}[/bold]")
    console.print(f"[dim]Command: {' '.join(cmd)}[/dim]")
    console.print(f"[bold blue]{'=' * 60}[/bold blue]\n")

    # S603: Safe - cmd is constructed from sys.executable and validated constants/terms
    result = subprocess.run(cmd, check=False)  # noqa: S603
    if result.returncode != 0:
        console.print(
            f"\n[red]Step '{step_name}' failed with exit code {result.returncode}[/red]"
        )
        return False
    console.print(f"\n[green]Step '{step_name}' completed successfully[/green]")
    return True


def _validate_term(term: str) -> str:
    """Validate that a term looks like a year (4 digits).

    Raises ValueError for invalid terms to prevent command injection.
    """
    if not term.isdigit() or len(term) != 4:
        msg = f"Invalid term '{term}': must be a 4-digit year"
        raise ValueError(msg)
    return term


def _build_term_args(terms: list[str] | None) -> list[str]:
    """Build --term arguments for commands.

    Validates each term to ensure it's a valid year format.
    """
    if not terms:
        return []
    args = []
    for term in terms:
        validated = _validate_term(term)
        args.extend(["--term", validated])
    return args


def _run_phase(
    phase_name: str,
    steps: list[tuple[str, list[str], bool]],
    base_cmd: list[str],
    term_args: list[str],
) -> list[str]:
    """Run a phase of the pipeline and return list of failed step names."""
    console.print(f"\n[bold magenta]{phase_name}[/bold magenta]")
    failed = []
    for step_name, cmd_parts, use_terms in steps:
        cmd = [*base_cmd, *cmd_parts]
        if use_terms:
            cmd.extend(term_args)
        if not _run_step(step_name, cmd):
            failed.append(step_name.lower())
    return failed


@pipeline_app.command(name="run")
def pipeline_run(
    terms: Annotated[
        list[str] | None,
        typer.Option("--term", "-T", help="Filter to specific term(s)"),
    ] = None,
    skip_scrape: Annotated[
        bool,
        typer.Option("--skip-scrape", help="Skip scraping steps (use cached data)"),
    ] = False,
    skip_process: Annotated[
        bool,
        typer.Option("--skip-process", help="Skip processing steps"),
    ] = False,
    skip_dataset: Annotated[
        bool,
        typer.Option("--skip-dataset", help="Skip dataset creation steps"),
    ] = False,
) -> None:
    """Run the full pipeline from scraping to dataset creation.

    This command runs all steps in order:
    1. Scrape: index, cases, transcripts, audio
    2. Process: index, cases, transcripts, audio, speakers
    3. Dataset: raw, flex, simple

    Use --term to filter to specific court terms.
    Use --skip-* flags to skip certain phases.
    """
    console.print("[bold cyan]Starting Oyez SA-ASR Pipeline[/bold cyan]")
    if terms:
        console.print(f"Terms: {', '.join(terms)}")
    else:
        console.print("Terms: all available")
    console.print()

    base_cmd = [sys.executable, "-m", "oyez_sa_asr"]
    term_args = _build_term_args(terms)
    failed_steps: list[str] = []

    if not skip_scrape:
        failed_steps.extend(
            _run_phase("Phase 1: Scraping", SCRAPE_STEPS, base_cmd, term_args)
        )

    if not skip_process:
        failed_steps.extend(
            _run_phase("Phase 2: Processing", PROCESS_STEPS, base_cmd, term_args)
        )

    if not skip_dataset:
        failed_steps.extend(
            _run_phase("Phase 3: Dataset Creation", DATASET_STEPS, base_cmd, term_args)
        )

    # Summary
    console.print("\n" + "=" * 60)
    console.print("[bold]Pipeline Summary[/bold]")
    console.print("=" * 60)

    if failed_steps:
        console.print(f"\n[red]Failed steps ({len(failed_steps)}):[/red]")
        for step in failed_steps:
            console.print(f"  - {step}")
        console.print("\n[yellow]Pipeline completed with errors.[/yellow]")
        raise typer.Exit(1)

    console.print("\n[bold green]Pipeline completed successfully![/bold green]")
    console.print("\nNext steps:")
    console.print("  - View stats: oyez stats audio")
    console.print("  - Explore datasets: python examples/demo_simple_dataset.py")


def register_pipeline_command(app: typer.Typer) -> None:
    """Register the pipeline command with the main app."""
    app.add_typer(pipeline_app, name="pipeline")
