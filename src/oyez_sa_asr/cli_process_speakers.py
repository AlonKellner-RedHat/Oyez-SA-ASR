# Generated by Claude
"""Process speakers command for oyez_sa_asr CLI."""

import json
from pathlib import Path
from typing import Annotated

import typer
from rich.console import Console
from tqdm import tqdm

from .speaker_models import SpeakerProfile
from .term_filter import filter_dirs

console = Console(force_terminal=True)


def _load_case_names(cases_dir: Path, terms: list[str] | None) -> dict[str, str]:
    """Load case names from processed case files.

    Returns a dict mapping "term/docket" to case name.
    """
    case_names: dict[str, str] = {}

    if not cases_dir.exists():
        return case_names

    term_dirs = filter_dirs(list(cases_dir.iterdir()), terms)

    for term_dir in term_dirs:
        if not term_dir.is_dir():
            continue

        for case_file in term_dir.glob("*.json"):
            try:
                with case_file.open() as f:
                    data = json.load(f)
                term = data.get("term", term_dir.name)
                docket = data.get("docket_number", case_file.stem)
                name = data.get("name", "Unknown Case")
                case_names[f"{term}/{docket}"] = name
            except (json.JSONDecodeError, KeyError):
                continue

    return case_names


def _process_transcript_file(
    transcript_file: Path,
    speakers: dict[int, SpeakerProfile],
    case_names: dict[str, str],
) -> int:
    """Process a single transcript file and update speaker profiles.

    Returns number of turns processed.
    """
    try:
        with transcript_file.open() as f:
            data = json.load(f)
    except json.JSONDecodeError:
        return 0

    term = data.get("term", "")
    docket = data.get("case_docket", "")
    transcript_type = data.get("type", "unknown")
    case_key = f"{term}/{docket}"
    case_name = case_names.get(case_key, "Unknown Case")

    # Track per-speaker stats for this transcript
    transcript_speakers: dict[int, dict] = {}

    for turn in data.get("turns", []):
        if not turn.get("is_valid"):
            continue

        speaker_id = turn.get("speaker_id")
        if speaker_id is None:
            continue

        speaker_name = turn.get("speaker_name", "Unknown")
        duration = turn.get("duration", 0.0) or 0.0
        word_count = turn.get("word_count", 0) or 0

        # Initialize speaker profile if needed
        if speaker_id not in speakers:
            speakers[speaker_id] = SpeakerProfile(id=speaker_id, name=speaker_name)

        # Aggregate within this transcript
        if speaker_id not in transcript_speakers:
            transcript_speakers[speaker_id] = {
                "turns": 0,
                "duration": 0.0,
                "words": 0,
            }

        transcript_speakers[speaker_id]["turns"] += 1
        transcript_speakers[speaker_id]["duration"] += duration
        transcript_speakers[speaker_id]["words"] += word_count

    # Add appearances for each speaker in this transcript
    for speaker_id, stats in transcript_speakers.items():
        speakers[speaker_id].add_appearance(
            term=term,
            docket=docket,
            case_name=case_name,
            transcript_type=transcript_type,
            turns=stats["turns"],
            duration_seconds=stats["duration"],
            word_count=stats["words"],
        )

    return len(transcript_speakers)


def process_speakers(
    transcripts_dir: Annotated[
        Path,
        typer.Option(
            "--transcripts-dir", "-t", help="Directory with processed transcripts"
        ),
    ] = Path("data/transcripts"),
    cases_dir: Annotated[
        Path,
        typer.Option("--cases-dir", "-c", help="Directory with processed cases"),
    ] = Path("data/cases"),
    output_dir: Annotated[
        Path,
        typer.Option("--output-dir", "-o", help="Output directory for speaker files"),
    ] = Path("data/speakers"),
    terms: Annotated[
        list[str] | None,
        typer.Option("--term", "-T", help="Filter to specific term(s)"),
    ] = None,
) -> None:
    """Aggregate speaker data from transcripts into per-speaker JSON files.

    Creates one JSON file per speaker at data/speakers/{id}_{name_slug}.json
    with recordings, turn counts, durations, and other statistics.
    """
    console.print("[bold]Processing speakers from transcripts[/bold]")
    console.print(f"  Transcripts dir: {transcripts_dir}")
    console.print(f"  Cases dir: {cases_dir}")
    console.print(f"  Output dir: {output_dir}")
    if terms:
        console.print(f"  Terms: {', '.join(terms)}")
    console.print()

    if not transcripts_dir.exists():
        console.print(f"[yellow]Warning:[/yellow] {transcripts_dir} not found.")
        console.print("Run 'oyez process transcripts' first.")
        return

    # Load case names for enrichment
    console.print("Loading case names...")
    case_names = _load_case_names(cases_dir, terms)
    console.print(f"  Found {len(case_names)} cases")

    # Collect all transcript files
    transcript_files: list[Path] = []
    term_dirs = filter_dirs(list(transcripts_dir.iterdir()), terms)

    for term_dir in term_dirs:
        if not term_dir.is_dir():
            continue
        for docket_dir in term_dir.iterdir():
            if not docket_dir.is_dir():
                continue
            transcript_files.extend(docket_dir.glob("*.json"))

    if not transcript_files:
        console.print("[yellow]No transcripts found.[/yellow]")
        return

    console.print(f"Processing {len(transcript_files)} transcripts...")

    # Process all transcripts
    speakers: dict[int, SpeakerProfile] = {}
    processed_count = 0

    for transcript_file in tqdm(transcript_files, desc="Processing", unit="file"):
        count = _process_transcript_file(transcript_file, speakers, case_names)
        if count > 0:
            processed_count += 1

    console.print()
    console.print(f"  Processed {processed_count} transcripts")
    console.print(f"  Found {len(speakers)} unique speakers")

    # Save speaker profiles
    output_dir.mkdir(parents=True, exist_ok=True)
    saved_count = 0

    for profile in tqdm(speakers.values(), desc="Saving", unit="speaker"):
        profile.save(output_dir)
        saved_count += 1

    console.print()
    console.print(f"[bold green]Done![/bold green] Saved {saved_count} speaker files.")
    console.print(f"Output: {output_dir}")


def add_speakers_command(app: typer.Typer) -> None:
    """Register the speakers command with the process app."""
    app.command(name="speakers")(process_speakers)
