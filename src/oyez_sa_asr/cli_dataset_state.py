# Generated by Claude
"""Dataset state management for detecting changes and ensuring consistency."""

import json
import shutil
from dataclasses import asdict, dataclass, field
from pathlib import Path
from typing import Any

# Current schema version - increment when index structure changes
SCHEMA_VERSION = 1


@dataclass
class DatasetState:
    """Represents the state of a generated dataset."""

    version: int
    terms: list[str]
    completed: bool
    created_by: str
    settings: dict[str, Any] = field(default_factory=dict)

    def to_dict(self) -> dict[str, Any]:
        """Convert to dictionary for JSON serialization."""
        return asdict(self)

    @classmethod
    def from_dict(cls, data: dict[str, Any]) -> "DatasetState":
        """Create from dictionary (loaded from JSON)."""
        return cls(
            version=data.get("version", 0),
            terms=data.get("terms", []),
            completed=data.get("completed", False),
            created_by=data.get("created_by", ""),
            settings=data.get("settings", {}),
        )


def load_state(output_dir: Path) -> DatasetState | None:
    """Load existing dataset state from index.json.

    Returns None if index.json doesn't exist or is invalid.
    """
    index_file = output_dir / "index.json"
    if not index_file.exists():
        return None

    try:
        with index_file.open() as f:
            data = json.load(f)
        return DatasetState.from_dict(data)
    except (json.JSONDecodeError, OSError):
        return None


def check_match(current: DatasetState, existing: DatasetState | None) -> bool:
    """Check if current state matches existing state.

    Returns True only if:
    - existing state exists
    - version matches
    - terms match (sorted comparison)
    - settings match
    - completed is True
    """
    if existing is None:
        return False

    if existing.version != current.version:
        return False

    if sorted(existing.terms) != sorted(current.terms):
        return False

    if existing.settings != current.settings:
        return False

    return existing.completed


def clean_dataset(output_dir: Path) -> int:
    """Remove all files in a dataset directory.

    Returns the count of files removed. If removal fails, returns 0 and
    logs a warning but does not raise.
    """
    if not output_dir.exists():
        return 0

    count = sum(1 for _ in output_dir.rglob("*") if _.is_file())
    try:
        shutil.rmtree(output_dir)
    except OSError:
        # If cleanup fails, the caller will attempt to overwrite
        # The incomplete state (completed=False) ensures retry on next run
        return 0
    return count


def save_state(output_dir: Path, state: DatasetState) -> None:
    """Save dataset state to index.json."""
    output_dir.mkdir(parents=True, exist_ok=True)
    index_file = output_dir / "index.json"
    with index_file.open("w") as f:
        json.dump(state.to_dict(), f, indent=2)


def make_state(
    created_by: str,
    terms: list[str] | None,
    completed: bool = False,
    **settings: Any,
) -> DatasetState:
    """Create a new DatasetState with current schema version."""
    return DatasetState(
        version=SCHEMA_VERSION,
        terms=sorted(terms) if terms else [],
        completed=completed,
        created_by=created_by,
        settings=settings,
    )
